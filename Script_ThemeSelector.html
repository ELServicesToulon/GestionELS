<script>
(function() {
  // Util: retire un Ã©ventuel wrapper <style> ... </style>
  function stripStyleTags(s) {
    if (!s) return '';
    try {
      return String(s)
        .replace(/<\/?style[^>]*>/gi, '')
        .trim();
    } catch (_) { return String(s); }
  }

  const THEMES_CSS = {
    <? for (var key in THEMES) { ?>
    "<?= key ?>": stripStyleTags(`<?!= include('<?= THEMES[key] ?>') ?>`),
    <? } ?>
  };
  const THEME_DEFAULT = "<?= THEME_DEFAULT ?>";
  const SELECTION_ENABLED = <?= THEME_SELECTION_ENABLED ?>;

  function applyTheme(id) {
    const css = THEMES_CSS[id] || THEMES_CSS[THEME_DEFAULT];
    const styleEl = document.getElementById('theme-style');
    if (styleEl) styleEl.textContent = css;
  }

  function loadTheme() {
    let theme = null;
    try { theme = localStorage.getItem('els_theme'); } catch (e) {}
    if (theme) {
      applyTheme(theme);
    } else {
      applyTheme(THEME_DEFAULT);
      if (typeof google !== 'undefined' && google.script) {
        google.script.run.withSuccessHandler(applyTheme).getUserTheme();
      }
    }
  }

  function saveTheme(id) {
    try { localStorage.setItem('els_theme', id); } catch (e) {}
    if (typeof google !== 'undefined' && google.script) {
      google.script.run.setUserTheme(id);
    }
  }

  function setupUI() {
    if (!SELECTION_ENABLED) return;
    const btn = document.getElementById('btn-theme');
    const menu = document.getElementById('menu-theme');
    if (!btn || !menu) return;
    btn.classList.remove('hidden');
    btn.setAttribute('aria-expanded', 'false');
    btn.addEventListener('click', () => {
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', String(!expanded));
      menu.classList.toggle('hidden');
      if (!expanded) {
        menu.querySelector('button').focus();
      } else {
        btn.focus();
      }
    });
    menu.querySelectorAll('.option-theme').forEach(opt => {
      opt.addEventListener('click', () => {
        const t = opt.dataset.theme;
        applyTheme(t);
        saveTheme(t);
        menu.classList.add('hidden');
        btn.focus();
      });
    });
    document.addEventListener('click', e => {
      if (!menu.contains(e.target) && e.target !== btn) {
        menu.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
      }
    });
    document.addEventListener('keydown', e => {
      if (menu.classList.contains('hidden')) return;
      if (e.key === 'Escape') {
        menu.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
        btn.focus();
      } else if (e.key === 'Tab') {
        setTimeout(() => {
          if (!menu.contains(document.activeElement)) {
            menu.classList.add('hidden');
            btn.setAttribute('aria-expanded', 'false');
            btn.focus();
          }
        }, 0);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadTheme();
    setupUI();
  });
})();
</script>
