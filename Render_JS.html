<script>
function escapeHTML(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function sanitizeHTML(html) {
  const template = document.createElement('template');
  template.innerHTML = html;
  // Remove script tags
  template.content.querySelectorAll('script').forEach(el => el.remove());

  const isSafeUrl = (url) => {
    if (!url) return true;
    const u = String(url).trim().toLowerCase();
    if (u.startsWith('#') || u.startsWith('/') || u.startsWith('./') || u.startsWith('../')) return true;
    return (
      u.startsWith('http:') ||
      u.startsWith('https:') ||
      u.startsWith('mailto:') ||
      u.startsWith('tel:')
    );
  };

  const sanitizeNode = (node) => {
    if (node.nodeType !== Node.ELEMENT_NODE) return;
    for (const attr of Array.from(node.attributes)) {
      const name = attr.name.toLowerCase();
      if (name.startsWith('on')) {
        node.removeAttribute(attr.name);
        continue;
      }
      if (name === 'href' || name === 'src' || name === 'action') {
        if (!isSafeUrl(attr.value)) {
          node.removeAttribute(attr.name);
        }
      }
    }
    for (const child of Array.from(node.children)) sanitizeNode(child);
  };

  for (const el of Array.from(template.content.children)) sanitizeNode(el);
  return template.innerHTML;
}

function renderText(el, text) {
  if (el) el.textContent = text;
}

function renderHTML(el, html) {
  if (el) el.innerHTML = sanitizeHTML(html);
}

function renderMessage(el, text, tag = 'p') {
  if (!el) return;
  const node = document.createElement(tag);
  node.textContent = text;
  el.replaceChildren(node);
}

// Gestion du focus dans les modales
function trapFocus(modal) {
  const FOCUSABLE = modal.querySelectorAll('a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])');
  if (!FOCUSABLE.length) return () => {};
  const first = FOCUSABLE[0], last = FOCUSABLE[FOCUSABLE.length - 1];
  function onKey(e) {
    if (e.key === 'Escape') {
      modal.close?.();
      if (!modal.close) modal.classList.add('hidden');
    }
    if (e.key !== 'Tab') return;
    if (e.shiftKey && document.activeElement === first) {
      e.preventDefault();
      last.focus();
    } else if (!e.shiftKey && document.activeElement === last) {
      e.preventDefault();
      first.focus();
    }
  }
  modal.addEventListener('keydown', onKey);
  return () => modal.removeEventListener('keydown', onKey);
}

// Anti double-clic sur les boutons
function lockButton(btn) {
  if (!btn) return () => {};
  btn.disabled = true;
  const spinner = document.createElement('span');
  spinner.className = 'spinner-inline';
  btn.appendChild(spinner);
  return () => {
    btn.disabled = false;
    spinner.remove();
  };
}
</script>
