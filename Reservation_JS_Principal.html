<script>
/**
 * =================================================================
 * MODULE JAVASCRIPT - PRINCIPAL
 * =================================================================
 * Description: Point d'entrée principal du script côté client.
 * Initialise l'état de l'application, configure les écouteurs
 * d'événements et lance l'affichage initial.
 */

/**
 * Initialise les drapeaux avec des valeurs par défaut et les fusionne avec ceux fournis.
 * @param {Object} [flags={}] Drapeaux provenant du serveur.
 * @returns {Object} Objet de drapeaux complété.
 */
function initializeFlags(flags = {}) {
  const defaults = {
    clientPortalEnabled: false,
    clientPortalSignedLinks: false,
    privacyLinkEnabled: false,
    slotsAmpmEnabled: false,
    billingMultiSheetEnabled: false,
    caEnCoursEnabled: false,
    calendarResyncEnabled: false,
    calendarPurgeEnabled: false,
    calendarBarOpacityEnabled: false,
    reservationUiV2Enabled: false,
    residentBillingEnabled: false,
    billingModalEnabled: false,
    debugMenuEnabled: false,
    demoReservationEnabled: false,
    billingV2Dryrun: false,
    requestLoggingEnabled: false,
    postEndpointEnabled: false,
    configCacheEnabled: false,
    reservationCacheEnabled: false,
    themeV2Enabled: false,
    elsUiThemingEnabled: false,
    cartResetEnabled: false,
    devisEnabled: false

  };
  return Object.assign({}, defaults, flags);
}

// État global de l'application côté client
window.etat = {
  dateActuelle: new Date(),
  panier: [],
  tourneeEnCours: {}, // Sera peuplé lors de la configuration
  clientReconnu: null,
  flags: initializeFlags() // Flags d'activation issus de Configuration.gs
};

/**
 * Affiche une notification éphémère.
 * @param {string} message
 * @param {('succes'|'info'|'erreur')} [type='succes']
 */
function afficherNotification(message, type = 'succes') {
  const conteneur = document.getElementById('conteneur-notifications');
  if (!conteneur) return;
  const notif = document.createElement('div');
  notif.className = `notification ${type}`;
  notif.textContent = message;
  conteneur.appendChild(notif);
  setTimeout(() => notif.remove(), 5000);
}

/**
 * Affiche ou masque l'indicateur de chargement global.
 * @param {boolean} afficher - true pour afficher, false pour masquer.
 */
function basculerIndicateurChargement(afficher) {
  const indicateur = document.getElementById('indicateur-chargement');
  if (!indicateur) return;
  indicateur.classList.toggle('hidden', !afficher);
}

/**
 * Gestion d'erreur standardisée.
 * @param {any} erreur
 */
function afficherErreur(erreur) {
  basculerIndicateurChargement(false);
  const message = (erreur && erreur.message) ? erreur.message : String(erreur || 'Erreur inconnue');
  console.error('[ELS]', erreur);
  afficherNotification(`Erreur : ${message}`, 'erreur');
}

/**
 * Affiche le conteneur de finalisation et pré-remplit les champs client.
 */
function afficherConteneurFinalisation() {
  const { ui } = window;
  const { clientReconnu, flags } = window.etat;

  if (flags && flags.clientPortalEnabled === false) return;

  if (clientReconnu) {
    ui.champEmailClient.value = clientReconnu.email;
    ui.champNomClient.value = clientReconnu.nom;
    ui.champAdresseClient.value = clientReconnu.adresse || '';
    ui.champSiretClient.value = clientReconnu.siret || '';
    ui.champEmailClient.readOnly = true;
    ui.champNomClient.readOnly = true;
  } else {
    if (ui.formulaireReservation) ui.formulaireReservation.reset();
    ui.champEmailClient.readOnly = false;
    ui.champNomClient.readOnly = false;
  }

  ui.conteneurFinalisation.classList.remove('hidden');
  ui.champEmailClient.focus();
}

/**
 * Gère la demande d'envoi de devis par email.
 */
function gererDemandeDevis() {
  const { ui } = window;
  const { panier, flags } = window.etat;

  if (flags?.devisEnabled === false) {
    afficherNotification('La demande de devis est désactivée.', 'info');
    return;
  }

  if (panier.length === 0) {
    afficherNotification('Votre panier est vide.', 'erreur');
    return;
  }

  let email = ui.champEmailClient?.value.trim();
  if (!email && window.etat.clientReconnu) {
    email = window.etat.clientReconnu.email;
  }

  if (email) {
    envoyerDevis(email);
  } else {
    document.getElementById('modale-email-devis')?.classList.remove('hidden');
  }
}

/**
 * Collecte les données et appelle le serveur pour envoyer le devis.
 * @param {string} email
 */
function envoyerDevis(email) {
  const { ui } = window;
  const { panier, flags } = window.etat;

  if (flags?.devisEnabled === false) {
    afficherNotification('La demande de devis est désactivée.', 'info');
    return;
  }

  basculerIndicateurChargement(true);

  const donneesDevis = {
    client: {
      email: email,
      nom: ui.champNomClient?.value.trim() || window.etat.clientReconnu?.nom || ''
    },
    items: panier
  };

  google.script.run
    .withSuccessHandler(reponse => {
      basculerIndicateurChargement(false);
      if (reponse.success) {
        afficherNotification(`Un devis a été envoyé à ${email}`, 'succes');
      } else {
        afficherErreur(reponse.error || "L'envoi du devis a échoué.");
      }
    })
    .withFailureHandler(afficherErreur)
    .envoyerDevisParEmail(donneesDevis);
}

/**
 * Ouvre la modale de coordonnées de facturation et gère la saisie.
 * @param {Object} opts
 */
function openBillingModal(opts = {}) {
  const modal = document.getElementById('modale-billing');
  if (!modal) return;
  const form = document.getElementById('formulaire-billing');
  const btnAnnuler = document.getElementById('btn-billing-annuler');
  const btnFermer = document.getElementById('btn-fermer-billing');
  const btnSwitch = document.getElementById('btn-billing-switch');
  let lastFocus = document.activeElement;

  function remplir(data) {
    form.billingNom.value = data.nom || '';
    form.billingAdresse.value = data.adresse || '';
    form.billingEmail.value = data.email || '';
    form.billingTelephone.value = data.telephone || '';
    form.billingSiret.value = data.siret || '';
    form.billingTva.value = data.tva || '';
  }

  if (opts.defaults) {
    remplir(opts.defaults);
  } else {
    google.script.run.withSuccessHandler(r => {
      if (r && r.defaults) remplir(r.defaults);
    }).doGetBillingDefaults(opts.orderId, opts.billTo, opts.ctx);
  }

  if (opts.mode === 'existant') {
    Array.from(form.elements).forEach(el => {
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
        el.readOnly = true;
      }
    });
    btnSwitch.classList.remove('hidden');
  } else {
    btnSwitch.classList.add('hidden');
  }

  function activerEdition() {
    Array.from(form.elements).forEach(el => {
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
        el.readOnly = false;
      }
    });
    btnSwitch.classList.add('hidden');
  }
  btnSwitch.addEventListener('click', activerEdition, { once: true });

  function fermer() {
    modal.classList.add('hidden');
    form.reset();
    btnSwitch.classList.add('hidden');
    modal.removeEventListener('keydown', trap);    
    if (lastFocus) lastFocus.focus();
  }

  btnAnnuler.addEventListener('click', fermer, { once: true });
  btnFermer.addEventListener('click', fermer, { once: true });

  form.addEventListener('submit', e => {
    e.preventDefault();
    const payload = {
      orderId: opts.orderId,
      billTo: opts.billTo,
      nom: form.billingNom.value.trim(),
      adresse: form.billingAdresse.value.trim(),
      email: form.billingEmail.value.trim(),
      telephone: form.billingTelephone.value.trim(),
      siret: form.billingSiret.value.trim(),
      tva: form.billingTva.value.trim()
    };
    google.script.run.withSuccessHandler(res => {
      if (res && res.success) {
        fermer();
        window.dispatchEvent(new CustomEvent('billing:saved', { detail: res }));
      } else {
        afficherNotification('Erreur lors de l\'enregistrement.', 'erreur');
      }
    }).doSaveBillingForOrder(payload);
  }, { once: true });

  function trap(ev) {
    if (ev.key === 'Escape') {
      fermer();
    }
    if (ev.key === 'Tab') {
      const focusables = modal.querySelectorAll('button, [href], input, textarea, select, [tabindex]:not([tabindex="-1"])');
      const list = Array.prototype.filter.call(focusables, el => !el.disabled && el.offsetParent !== null);
      if (list.length === 0) return;
      const first = list[0];
      const last = list[list.length - 1];
      if (ev.shiftKey && document.activeElement === first) {
        ev.preventDefault();
        last.focus();
      } else if (!ev.shiftKey && document.activeElement === last) {
        ev.preventDefault();
        first.focus();
      }
    }
  }
  modal.addEventListener('keydown', trap);

  modal.classList.remove('hidden');
  const firstField = modal.querySelector('input, textarea, select, button');
  if (firstField) firstField.focus();
}

/**

 * Gère la soumission du formulaire de réservation final.
 * @param {SubmitEvent} e
 */
function gererSoumissionReservation(e) {
  e.preventDefault();
  const { ui } = window;
  const { panier } = window.etat;

  if (panier.length === 0) {
    afficherNotification("Votre panier est vide.", 'erreur');
    return;
  }

  const donneesReservation = {
    client: {
      email: ui.champEmailClient.value.trim(),
      nom: ui.champNomClient.value.trim(),
      adresse: ui.champAdresseClient.value.trim(),
      siret: ui.champSiretClient.value.trim(),
      note: ui.champNoteReservation.value.trim()
    },
    items: panier
  };

  function envoyer() {
    basculerIndicateurChargement(true);
    google.script.run
      .withSuccessHandler(reponse => {
        basculerIndicateurChargement(false);
        if (reponse.success) {
          afficherNotification("Réservation confirmée ! Un email vous a été envoyé.", 'succes');
          window.etat.panier = [];
          sauvegarderPanierDansLocalStorage();
          afficherPanier();
          ui.conteneurFinalisation.classList.add('hidden');
          if (typeof CLIENT_SESSION_OPAQUE_ID_ENABLED !== 'undefined' && CLIENT_SESSION_OPAQUE_ID_ENABLED) {
            sauvegarderSessionClient(donneesReservation.client.email);
          } else {
            localStorage.setItem(CLE_LOCALSTORAGE_CLIENT, JSON.stringify(donneesReservation.client));
          }
        } else {
          afficherErreur(reponse.summary || "Une erreur est survenue lors de la réservation.");
          if (reponse.failedItemIds && reponse.failedItemIds.length > 0) {
            window.etat.panier = window.etat.panier.filter(item => !reponse.failedItemIds.includes(item.id));
            sauvegarderPanierDansLocalStorage();
            afficherPanier();
          }
        }
      })
      .withFailureHandler(afficherErreur)
      .reserverPanier(donneesReservation);
  }

  if (window.etat.flags.billingModalEnabled) {
    openBillingModal({ orderId: Date.now().toString(), billTo: 'resident', mode: 'existant' });
    const handler = () => {
      window.removeEventListener('billing:saved', handler);
      envoyer();
    };
    window.addEventListener('billing:saved', handler);
  } else {
    envoyer();
  }
}

/**
 * Affiche ou masque le bouton "Vider Panier" et gère son écouteur.
 */
function mettreAJourBoutonViderPanier() {
  const { ui } = window;

  ui.btnViderPanier?.removeEventListener('click', viderPanier);
  if (window.etat.flags.cartResetEnabled) {
    ui.btnViderPanier?.classList.remove('hidden');
    ui.btnViderPanier?.addEventListener('click', viderPanier);
  } else {
    ui.btnViderPanier?.classList.add('hidden');
  }
}

/**
 * Configure tous les écouteurs d'événements de l'application.
 */
function configurerEcouteursEvenements() {
  const { ui } = window;

  // Gère les clics sur les jours du calendrier.
  ui.grilleCalendrier?.addEventListener('click', (e) => {
    const jourClique = e.target.closest('.jour-calendrier');
    if (jourClique && !jourClique.classList.contains('desactive')) {
      const dateString = jourClique.dataset.date;
      if(dateString) {
        ouvrirConfigurationTournee(dateString);
      }
    }
  });

  // Navigation du calendrier
  ui.btnMoisPrecedent?.addEventListener('click', () => changerMois(-1));
  ui.btnMoisSuivant?.addEventListener('click', () => changerMois(1));

  // Écouteur pour le formulaire de configuration de tournée
  ui.formulaireConfigTournee?.addEventListener('submit', gererDemandeCreneaux);

  // Actions de la modale de configuration (Modale 1)
  ui.btnFermerConfigTournee?.addEventListener('click', () => ui.modaleConfigTournee.classList.add('hidden'));
  ui.btnAjouterArret?.addEventListener('click', () => {
    ui.valeurArretsSup.textContent = parseInt(ui.valeurArretsSup.textContent) + 1;
    mettreAJourResumeTournee();
  });
  ui.btnRetirerArret?.addEventListener('click', () => {
    const valeur = parseInt(ui.valeurArretsSup.textContent);
    if (valeur > 1) {
      ui.valeurArretsSup.textContent = valeur - 1;
      mettreAJourResumeTournee();
    }
  });
  ui.interrupteurRetour?.addEventListener('change', mettreAJourResumeTournee);

  // Actions de la modale de sélection de créneau (Modale 2)
  ui.btnFermerSelectionCreneau?.addEventListener('click', () => ui.modaleSelectionCreneau.classList.add('hidden'));
  ui.btnAjouterAuPanier?.addEventListener('click', gererAjoutAuPanier);
  ui.btnModifierTournee?.addEventListener('click', retourVersConfiguration);

  // Écouteurs pour la modale de confirmation de récurrence (Modale 3)
  const modaleRecurrence = document.getElementById('modale-confirmation-recurrence');
  document.getElementById('btn-confirmer-recurrence')?.addEventListener('click', confirmerEtAjouterRecurrenceAuPanier);
  document.getElementById('btn-fermer-confirmation-recurrence')?.addEventListener('click', () => modaleRecurrence.classList.add('hidden'));
  document.getElementById('btn-annuler-recurrence')?.addEventListener('click', () => modaleRecurrence.classList.add('hidden'));

  // Actions du panier et de la finalisation
  ui.btnValiderPanier?.addEventListener('click', afficherConteneurFinalisation);
  document.getElementById('btn-envoyer-devis')?.addEventListener('click', gererDemandeDevis);
  ui.formulaireReservation?.addEventListener('submit', gererSoumissionReservation);
  ui.btnAnnulerReservation?.addEventListener('click', () => ui.conteneurFinalisation.classList.add('hidden'));
  ui.listePanier?.addEventListener('click', gererActionsPanier);
  mettreAJourBoutonViderPanier();

  window.addEventListener('billing:saved', () => {
    afficherNotification('Coordonnées de facturation enregistrées.', 'succes');
  });

  // Écouteurs pour la modale de demande d'email pour le devis
  const modaleEmailDevis = document.getElementById('modale-email-devis');
  document.getElementById('formulaire-email-devis')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const emailInput = document.getElementById('email-pour-devis');
      if (emailInput && emailInput.value) {
          envoyerDevis(emailInput.value.trim());
          modaleEmailDevis.classList.add('hidden');
          emailInput.value = '';
      }
  });
  document.getElementById('btn-fermer-email-devis')?.addEventListener('click', () => {
      modaleEmailDevis.classList.add('hidden');
  });

  // Gestion du client
  ui.champEmailClient?.addEventListener('blur', (e) => {
      if(e.target.value) {
          preRemplirInfosClient(e.target.value);
      }
  });
  ui.btnChangerClient?.addEventListener('click', reinitialiserClient);
}

/**
 * Point d'entrée principal, exécuté après le chargement du DOM.
 */
document.addEventListener('DOMContentLoaded', () => {
  google.script.run.withSuccessHandler(cfg => {
    window.etat.flags = initializeFlags(cfg);
    try {
      if (window.etat.flags && window.etat.flags.elsUiThemingEnabled) {
        document.body.classList.add('els-ui-theming');
        document.body.classList.add('els-aluminium'); // QA: fond aluminium activé
      }
    } catch (e) { /* no-op */ }
    mettreAJourBoutonViderPanier();
    configurerEcouteursEvenements();
  }).getConfiguration();
  chargerPanierDepuisLocalStorage();
  verifierSessionClient();
  afficherCalendrier(window.etat.dateActuelle.getMonth() + 1, window.etat.dateActuelle.getFullYear());
});

/**
 * Change le mois affiché dans le calendrier.
 * @param {number} delta - Le changement de mois (-1 pour précédent, 1 pour suivant).
 */
function changerMois(delta) {
    window.etat.dateActuelle.setMonth(window.etat.dateActuelle.getMonth() + delta);
    afficherCalendrier(window.etat.dateActuelle.getMonth() + 1, window.etat.dateActuelle.getFullYear());
}
</script>



