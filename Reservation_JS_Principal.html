<script>
/**
 * =================================================================
 * MODULE JAVASCRIPT - PRINCIPAL
 * =================================================================
 * Description: Point d'entrée principal du script côté client.
 * Initialise l'état de l'application, configure les écouteurs
 * d'événements et lance l'affichage initial.
 */

/**
 * Initialise les drapeaux avec des valeurs par défaut et les fusionne avec ceux fournis.
 * @param {Object} [flags={}] Drapeaux provenant du serveur.
 * @returns {Object} Objet de drapeaux complété.
 */
function initializeFlags(flags = {}) {
  const defaults = {
    clientPortalEnabled: false,
    clientPortalSignedLinks: false,
    privacyLinkEnabled: false,
    slotsAmpmEnabled: false,
    semainierEnabled: false,
    billingMultiSheetEnabled: false,
    caEnCoursEnabled: false,
    calendarResyncEnabled: false,
    calendarPurgeEnabled: false,
    reservationUiV2Enabled: false,
    residentBillingEnabled: false,
    debugMenuEnabled: false,
    demoReservationEnabled: false,
    billingV2Dryrun: false,
    requestLoggingEnabled: false,
    postEndpointEnabled: false,
    configCacheEnabled: false,
    reservationCacheEnabled: false,
    themeV2Enabled: false,
    themeSelectionEnabled: false,
    devisEnabled: false
  };
  return Object.assign({}, defaults, flags);
}

// État global de l'application côté client
window.etat = {
  dateActuelle: new Date(),
  panier: [],
  tourneeEnCours: {}, // Sera peuplé lors de la configuration
  clientReconnu: null,
  flags: initializeFlags() // Flags d'activation issus de Configuration.gs
};

/**
 * Affiche une notification éphémère.
 * @param {string} message
 * @param {('succes'|'info'|'erreur')} [type='succes']
 */
function afficherNotification(message, type = 'succes') {
  const conteneur = document.getElementById('conteneur-notifications');
  if (!conteneur) return;
  const notif = document.createElement('div');
  notif.className = `notification ${type}`;
  notif.textContent = message;
  conteneur.appendChild(notif);
  setTimeout(() => notif.remove(), 5000);
}

/**
 * Affiche ou masque l'indicateur de chargement global.
 * @param {boolean} afficher - true pour afficher, false pour masquer.
 */
function basculerIndicateurChargement(afficher) {
  const indicateur = document.getElementById('indicateur-chargement');
  if (!indicateur) return;
  indicateur.classList.toggle('hidden', !afficher);
}

/**
 * Gestion d'erreur standardisée.
 * @param {any} erreur
 */
function afficherErreur(erreur) {
  basculerIndicateurChargement(false);
  const message = (erreur && erreur.message) ? erreur.message : String(erreur || 'Erreur inconnue');
  console.error('[ELS]', erreur);
  afficherNotification(`Erreur : ${message}`, 'erreur');
}

/**
 * Affiche le conteneur de finalisation et pré-remplit les champs client.
 */
function afficherConteneurFinalisation() {
  const { ui } = window;
  const { clientReconnu, flags } = window.etat;

  if (flags && flags.clientPortalEnabled === false) return;

  if (clientReconnu) {
    ui.champEmailClient.value = clientReconnu.email;
    ui.champNomClient.value = clientReconnu.nom;
    ui.champAdresseClient.value = clientReconnu.adresse || '';
    ui.champSiretClient.value = clientReconnu.siret || '';
    ui.champEmailClient.readOnly = true;
    ui.champNomClient.readOnly = true;
  } else {
    if (ui.formulaireReservation) ui.formulaireReservation.reset();
    ui.champEmailClient.readOnly = false;
    ui.champNomClient.readOnly = false;
  }

  ui.conteneurFinalisation.classList.remove('hidden');
  ui.champEmailClient.focus();
}

/**
 * Gère la demande d'envoi de devis par email.
 */
function gererDemandeDevis() {
  const { ui } = window;
  const { panier, flags } = window.etat;

  if (flags?.devisEnabled === false) {
    afficherNotification('La demande de devis est désactivée.', 'info');
    return;
  }

  if (panier.length === 0) {
    afficherNotification('Votre panier est vide.', 'erreur');
    return;
  }

  let email = ui.champEmailClient?.value.trim();
  if (!email && window.etat.clientReconnu) {
    email = window.etat.clientReconnu.email;
  }

  if (email) {
    envoyerDevis(email);
  } else {
    document.getElementById('modale-email-devis')?.classList.remove('hidden');
  }
}

/**
 * Collecte les données et appelle le serveur pour envoyer le devis.
 * @param {string} email
 */
function envoyerDevis(email) {
  const { ui } = window;
  const { panier, flags } = window.etat;

  if (flags?.devisEnabled === false) {
    afficherNotification('La demande de devis est désactivée.', 'info');
    return;
  }

  basculerIndicateurChargement(true);

  const donneesDevis = {
    client: {
      email: email,
      nom: ui.champNomClient?.value.trim() || window.etat.clientReconnu?.nom || ''
    },
    items: panier
  };

  google.script.run
    .withSuccessHandler(reponse => {
      basculerIndicateurChargement(false);
      if (reponse.success) {
        afficherNotification(`Un devis a été envoyé à ${email}`, 'succes');
      } else {
        afficherErreur(reponse.error || "L'envoi du devis a échoué.");
      }
    })
    .withFailureHandler(afficherErreur)
    .envoyerDevisParEmail(donneesDevis);
}

/**
 * Gère la soumission du formulaire de réservation final.
 * @param {SubmitEvent} e
 */
function gererSoumissionReservation(e) {
  e.preventDefault();
  const { ui } = window;
  const { panier } = window.etat;

  if (panier.length === 0) {
    afficherNotification("Votre panier est vide.", 'erreur');
    return;
  }

  basculerIndicateurChargement(true);

  const donneesReservation = {
    client: {
      email: ui.champEmailClient.value.trim(),
      nom: ui.champNomClient.value.trim(),
      adresse: ui.champAdresseClient.value.trim(),
      siret: ui.champSiretClient.value.trim(),
      note: ui.champNoteReservation.value.trim()
    },
    items: panier
  };

  google.script.run
    .withSuccessHandler(reponse => {
      basculerIndicateurChargement(false);
      if (reponse.success) {
        afficherNotification("Réservation confirmée ! Un email vous a été envoyé.", 'succes');
        window.etat.panier = [];
        sauvegarderPanierDansLocalStorage();
        afficherPanier();
        ui.conteneurFinalisation.classList.add('hidden');
        localStorage.setItem(CLE_LOCALSTORAGE_CLIENT, JSON.stringify(donneesReservation.client));
      } else {
        afficherErreur(reponse.summary || "Une erreur est survenue lors de la réservation.");
        if (reponse.failedItemIds && reponse.failedItemIds.length > 0) {
          window.etat.panier = window.etat.panier.filter(item => !reponse.failedItemIds.includes(item.id));
          sauvegarderPanierDansLocalStorage();
          afficherPanier();
        }
      }
    })
    .withFailureHandler(afficherErreur)
    .reserverPanier(donneesReservation);
}

/**
 * Configure tous les écouteurs d'événements de l'application.
 */
function configurerEcouteursEvenements() {
  const { ui } = window;

  // Gère les clics sur les jours du calendrier.
  ui.grilleCalendrier?.addEventListener('click', (e) => {
    const jourClique = e.target.closest('.jour-calendrier');
    if (jourClique && !jourClique.classList.contains('desactive')) {
      const dateString = jourClique.dataset.date;
      if(dateString) {
        ouvrirConfigurationTournee(dateString);
      }
    }
  });

  // Navigation du calendrier
  ui.btnMoisPrecedent?.addEventListener('click', () => changerMois(-1));
  ui.btnMoisSuivant?.addEventListener('click', () => changerMois(1));

  // Écouteur pour le formulaire de configuration de tournée
  ui.formulaireConfigTournee?.addEventListener('submit', gererDemandeCreneaux);

  // Actions de la modale de configuration (Modale 1)
  ui.btnFermerConfigTournee?.addEventListener('click', () => ui.modaleConfigTournee.classList.add('hidden'));
  ui.btnAjouterArret?.addEventListener('click', () => {
    ui.valeurArretsSup.textContent = parseInt(ui.valeurArretsSup.textContent) + 1;
    mettreAJourResumeTournee();
  });
  ui.btnRetirerArret?.addEventListener('click', () => {
    const valeur = parseInt(ui.valeurArretsSup.textContent);
    if (valeur > 1) {
      ui.valeurArretsSup.textContent = valeur - 1;
      mettreAJourResumeTournee();
    }
  });
  ui.interrupteurRetour?.addEventListener('change', mettreAJourResumeTournee);

  // Actions de la modale de sélection de créneau (Modale 2)
  ui.btnFermerSelectionCreneau?.addEventListener('click', () => ui.modaleSelectionCreneau.classList.add('hidden'));
  ui.btnAjouterAuPanier?.addEventListener('click', gererAjoutAuPanier);
  ui.btnModifierTournee?.addEventListener('click', retourVersConfiguration);

  // Écouteurs pour la modale de confirmation de récurrence (Modale 3)
  const modaleRecurrence = document.getElementById('modale-confirmation-recurrence');
  document.getElementById('btn-confirmer-recurrence')?.addEventListener('click', confirmerEtAjouterRecurrenceAuPanier);
  document.getElementById('btn-fermer-confirmation-recurrence')?.addEventListener('click', () => modaleRecurrence.classList.add('hidden'));
  document.getElementById('btn-annuler-recurrence')?.addEventListener('click', () => modaleRecurrence.classList.add('hidden'));

  // Actions du panier et de la finalisation
  ui.btnValiderPanier?.addEventListener('click', afficherConteneurFinalisation);
  document.getElementById('btn-envoyer-devis')?.addEventListener('click', gererDemandeDevis);
  ui.formulaireReservation?.addEventListener('submit', gererSoumissionReservation);
  ui.btnAnnulerReservation?.addEventListener('click', () => ui.conteneurFinalisation.classList.add('hidden'));
  ui.listePanier?.addEventListener('click', gererActionsPanier);

  // Écouteurs pour la modale de demande d'email pour le devis
  const modaleEmailDevis = document.getElementById('modale-email-devis');
  document.getElementById('formulaire-email-devis')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const emailInput = document.getElementById('email-pour-devis');
      if (emailInput && emailInput.value) {
          envoyerDevis(emailInput.value.trim());
          modaleEmailDevis.classList.add('hidden');
          emailInput.value = '';
      }
  });
  document.getElementById('btn-fermer-email-devis')?.addEventListener('click', () => {
      modaleEmailDevis.classList.add('hidden');
  });

  // Gestion du client
  ui.champEmailClient?.addEventListener('blur', (e) => {
      if(e.target.value) {
          preRemplirInfosClient(e.target.value);
      }
  });
  ui.btnChangerClient?.addEventListener('click', reinitialiserClient);
}

/**
 * Point d'entrée principal, exécuté après le chargement du DOM.
 */
document.addEventListener('DOMContentLoaded', () => {
  google.script.run.withSuccessHandler(cfg => {
    window.etat.flags = initializeFlags(cfg);
  }).getConfiguration();
  chargerPanierDepuisLocalStorage();
  verifierSessionClient();
  afficherCalendrier(window.etat.dateActuelle.getMonth() + 1, window.etat.dateActuelle.getFullYear());
  configurerEcouteursEvenements();
});

/**
 * Change le mois affiché dans le calendrier.
 * @param {number} delta - Le changement de mois (-1 pour précédent, 1 pour suivant).
 */
function changerMois(delta) {
    window.etat.dateActuelle.setMonth(window.etat.dateActuelle.getMonth() + delta);
    afficherCalendrier(window.etat.dateActuelle.getMonth() + 1, window.etat.dateActuelle.getFullYear());
}
</script>



