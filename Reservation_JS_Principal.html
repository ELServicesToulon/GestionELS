<script>
/**
 * =================================================================
 * MODULE JAVASCRIPT - PRINCIPAL
 * =================================================================
 * Description: Point d'entrée principal du script côté client.
 * Initialise l'état de l'application, configure les écouteurs
 * d'événements et lance l'affichage initial.
 */

/**
 * Initialise les drapeaux avec des valeurs par défaut et les fusionne avec ceux fournis.
 * @param {Object} [flags={}] Drapeaux provenant du serveur.
 * @returns {Object} Objet de drapeaux complété.
 */
function initializeFlags(flags = {}) {
  const defaults = {
    clientPortalEnabled: false,
    clientPortalSignedLinks: false,
    privacyLinkEnabled: false,
    slotsAmpmEnabled: false,
    adresseAutocompleteEnabled: false,
    billingMultiSheetEnabled: false,
    caEnCoursEnabled: false,
    calendarResyncEnabled: false,
    calendarPurgeEnabled: false,
    calendarBarOpacityEnabled: false,
    reservationUiV2Enabled: false,
    residentBillingEnabled: false,
    billingModalEnabled: false,
    debugMenuEnabled: false,
    demoReservationEnabled: false,
    billingV2Dryrun: false,
    requestLoggingEnabled: false,
    postEndpointEnabled: false,
    configCacheEnabled: false,
      reservationCacheEnabled: false,
      reservationShowTakenSlotsEnabled: false,
      themeV2Enabled: false,
    elsUiThemingEnabled: false,
    cartResetEnabled: false,
    devisEnabled: false

  };
  return Object.assign({}, defaults, flags);
}

const CLE_LOCALSTORAGE_CODE_POSTAL = 'ELS_CODE_POSTAL_OFFICINE';
let releaseCodePostalFocus = () => {};

// État global de l'application côté client
window.etat = {
  dateActuelle: new Date(),
  panier: [],
  tourneeEnCours: {}, // Sera peuplé lors de la configuration
  clientReconnu: null,
  codePostalOfficine: '',
  adresseSuggestion: null,
  flags: initializeFlags() // Flags d'activation issus de Configuration.gs
};

function estForfaitResidentActif() {
  return !!(configServeur?.FORFAIT_RESIDENT_ENABLED && window.ui?.champResidentClient?.checked);
}

function obtenirModeResident() {
  if (!estForfaitResidentActif()) return 'standard';
  const radios = window.ui?.residentModeRadios || [];
  const active = radios.find(radio => radio.checked);
  return active?.value === 'urgence' ? 'urgence' : 'standard';
}

function obtenirLibelleResident(mode) {
  return mode === 'urgence' ? 'Forfait résident - Urgence' : 'Forfait résident - Standard';
}

function obtenirPrixResident(mode) {
  const standard = Number(configServeur?.FORFAIT_RESIDENT_STANDARD);
  const urgence = Number(configServeur?.FORFAIT_RESIDENT_URGENCE);
  if (mode === 'urgence' && Number.isFinite(urgence)) return urgence;
  if (Number.isFinite(standard)) return standard;
  return null;
}

window.estForfaitResidentActif = estForfaitResidentActif;
window.obtenirModeResident = obtenirModeResident;
window.obtenirPrixResident = obtenirPrixResident;
window.obtenirLibelleResident = obtenirLibelleResident;

function emettreEvenementCodePostal(code) {
  try {
    document.dispatchEvent(new CustomEvent('els-code-postal-change', { detail: code || '' }));
  } catch (_err) {
    // CustomEvent non supporté (IE11); on ignore simplement.
  }
}

function normaliserCodePostalLocal(valeur) {
  if (valeur === null || valeur === undefined) return '';
  const digits = String(valeur).replace(/\D/g, '');
  return digits.length === 5 ? digits : '';
}

function lireCodePostalStocke() {
  try {
    return localStorage.getItem(CLE_LOCALSTORAGE_CODE_POSTAL) || '';
  } catch (_e) {
    return '';
  }
}

function enregistrerCodePostalStocke(code) {
  if (!code) return;
  try {
    localStorage.setItem(CLE_LOCALSTORAGE_CODE_POSTAL, code);
  } catch (_e) {
    // ignore storage errors (navigation privée, etc.)
  }
}

function effacerCodePostalStocke() {
  try {
    localStorage.removeItem(CLE_LOCALSTORAGE_CODE_POSTAL);
  } catch (_e) {
    // ignore
  }
}

function definirCodePostalCourant(code, options = {}) {
  const normalise = normaliserCodePostalLocal(code);
  if (!normalise) {
    if (options.forceClear === true) {
      window.etat.codePostalOfficine = '';
      if (!options.skipStorage) {
        effacerCodePostalStocke();
      }
      if (window.ui?.champCodePostalClient) {
        window.ui.champCodePostalClient.value = '';
      }
      emettreEvenementCodePostal('');
    }
    return '';
  }
  window.etat.codePostalOfficine = normalise;
  if (!options.skipStorage) {
    enregistrerCodePostalStocke(normalise);
  }
  if (window.ui?.champCodePostalClient) {
    window.ui.champCodePostalClient.value = normalise;
    window.ui.champCodePostalClient.readOnly = true;
  }
  if (window.ui?.champCodePostalOverlay) {
    window.ui.champCodePostalOverlay.value = normalise;
  }
  if (window.etat?.clientReconnu) {
    window.etat.clientReconnu.codePostal = normalise;
  }
  cacherErreurCodePostal();
  emettreEvenementCodePostal(normalise);
  return normalise;
}

function obtenirCodePostalCourant() {
  if (window.etat.codePostalOfficine) {
    return window.etat.codePostalOfficine;
  }
  const valeurChamp = window.ui?.champCodePostalClient?.value;
  const normalise = normaliserCodePostalLocal(valeurChamp);
  if (normalise) {
    window.etat.codePostalOfficine = normalise;
    enregistrerCodePostalStocke(normalise);
  }
  return normalise;
}

function afficherErreurCodePostal(message) {
  const el = window.ui?.messageCodePostalErreur;
  if (!el) return;
  el.textContent = message || '';
  el.classList.toggle('hidden', !message);
}

function cacherErreurCodePostal() {
  afficherErreurCodePostal('');
}

function afficherVerrouCodePostal(message) {
  const overlay = window.ui?.codePostalOverlay;
  if (!overlay) return;
  overlay.classList.remove('hidden');
  overlay.setAttribute('aria-hidden', 'false');
  if (typeof trapFocus === 'function') {
    releaseCodePostalFocus = trapFocus(overlay);
  }
  const input = window.ui?.champCodePostalOverlay;
  if (input) {
    const valeur = window.etat.codePostalOfficine || lireCodePostalStocke();
    if (valeur) {
      input.value = valeur;
    }
    setTimeout(() => input.focus(), 0);
  }
  if (message) {
    afficherErreurCodePostal(message);
  } else {
    cacherErreurCodePostal();
  }
}

function masquerVerrouCodePostal() {
  const overlay = window.ui?.codePostalOverlay;
  if (!overlay) return;
  overlay.classList.add('hidden');
  overlay.setAttribute('aria-hidden', 'true');
  releaseCodePostalFocus();
  releaseCodePostalFocus = () => {};
}

function initialiserVerrouCodePostal() {
  if (!window.ui) {
    setTimeout(initialiserVerrouCodePostal, 0);
    return;
  }
  const ui = window.ui || {};
  const formulaire = ui.formulaireCodePostal;
  const champ = ui.champCodePostalOverlay;
  if (!formulaire || !champ) {
    return;
  }
  if (formulaire.dataset.initialized === 'true') {
    return;
  }
  formulaire.dataset.initialized = 'true';

  const codeStocke = normaliserCodePostalLocal(lireCodePostalStocke());
  if (codeStocke) {
    masquerVerrouCodePostal();
    basculerIndicateurChargement(true);
    google.script.run
      .withSuccessHandler(res => {
        basculerIndicateurChargement(false);
        if (res && res.success) {
          definirCodePostalCourant(res.codePostal || codeStocke);
          masquerVerrouCodePostal();
        } else {
          effacerCodePostalStocke();
          afficherVerrouCodePostal(res && res.message ? res.message : "Ce code postal n'est pas desservi.");
        }
      })
      .withFailureHandler(() => {
        basculerIndicateurChargement(false);
        afficherVerrouCodePostal("Impossible de vérifier le code postal pour le moment.");
      })
      .verifierCodePostalAcces(codeStocke);
  } else {
    afficherVerrouCodePostal();
  }

  formulaire.addEventListener('submit', (event) => {
    event.preventDefault();
    const normalise = normaliserCodePostalLocal(champ.value);
    if (!normalise) {
      afficherErreurCodePostal("Merci de saisir un code postal à 5 chiffres.");
      champ.focus();
      return;
    }
    basculerIndicateurChargement(true);
    google.script.run
      .withSuccessHandler(res => {
        basculerIndicateurChargement(false);
        if (res && res.success) {
          definirCodePostalCourant(res.codePostal || normalise);
          masquerVerrouCodePostal();
        } else {
          effacerCodePostalStocke();
          afficherErreurCodePostal(res && res.message ? res.message : "Ce code postal n'est pas desservi.");
        }
      })
      .withFailureHandler(() => {
        basculerIndicateurChargement(false);
        afficherErreurCodePostal("Impossible de vérifier le code postal pour le moment.");
      })
      .verifierCodePostalAcces(normalise);
  });

  ui.btnModifierCodePostal?.addEventListener('click', () => {
    champ.value = window.etat.codePostalOfficine || '';
    afficherVerrouCodePostal();
  });
}

window.definirCodePostalCourant = definirCodePostalCourant;
window.obtenirCodePostalCourant = obtenirCodePostalCourant;

function initialiserTarifsResident() {
  const formatter = new Intl.NumberFormat('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const elStandard = document.getElementById('resident-mode-standard-prix');
  const elUrgence = document.getElementById('resident-mode-urgence-prix');
  const prixStandard = obtenirPrixResident('standard');
  const prixUrgence = obtenirPrixResident('urgence');
  if (elStandard) {
    elStandard.textContent = Number.isFinite(prixStandard) ? `${formatter.format(prixStandard)} �` : 'Forfait standard';
  }
  if (elUrgence) {
    elUrgence.textContent = Number.isFinite(prixUrgence) ? `${formatter.format(prixUrgence)} �` : 'Forfait urgence';
  }
}


/**
 * Affiche une notification éphémère.
 * @param {string} message
 * @param {('succes'|'info'|'erreur')} [type='succes']
 */
function afficherNotification(message, type = 'succes') {
  const conteneur = document.getElementById('conteneur-notifications');
  if (!conteneur) return;
  const notif = document.createElement('div');
  notif.className = `notification ${type}`;
  notif.textContent = message;
  conteneur.appendChild(notif);
  setTimeout(() => notif.remove(), 5000);
}

/**
 * Affiche ou masque l'indicateur de chargement global.
 * @param {boolean} afficher - true pour afficher, false pour masquer.
 */
function basculerIndicateurChargement(afficher) {
  const indicateur = document.getElementById('indicateur-chargement');
  if (!indicateur) return;
  indicateur.classList.toggle('hidden', !afficher);
}

/**
 * Gestion d'erreur standardisée.
 * @param {any} erreur
 */
function afficherErreur(erreur) {
  basculerIndicateurChargement(false);
  const message = (erreur && erreur.message) ? erreur.message : String(erreur || 'Erreur inconnue');
  console.error('[ELS]', erreur);
  afficherNotification(`Erreur : ${message}`, 'erreur');
}

/**
 * Affiche le conteneur de finalisation et pré-remplit les champs client.
 */
function afficherConteneurFinalisation() {
  const { ui } = window;
  const { clientReconnu, flags } = window.etat;

  if (flags && flags.clientPortalEnabled === false) return;

  if (clientReconnu) {
    ui.champEmailClient.value = clientReconnu.email;
    ui.champNomClient.value = clientReconnu.nom;
    ui.champAdresseClient.value = clientReconnu.adresse || '';
    ui.champSiretClient.value = clientReconnu.siret || '';
    if (ui.champCodePostalClient) {
      const code = clientReconnu.codePostal || window.etat.codePostalOfficine || '';
      ui.champCodePostalClient.value = code;
      ui.champCodePostalClient.readOnly = true;
    }
    if (ui.champResidentClient) ui.champResidentClient.checked = !!clientReconnu.resident;
    ui.champEmailClient.readOnly = true;
    ui.champNomClient.readOnly = true;
  } else {
    if (ui.formulaireReservation) ui.formulaireReservation.reset();
    ui.champEmailClient.readOnly = false;
    ui.champNomClient.readOnly = false;
    if (ui.champResidentClient) ui.champResidentClient.checked = false;
    if (ui.champCodePostalClient) {
      ui.champCodePostalClient.value = window.etat.codePostalOfficine || '';
      ui.champCodePostalClient.readOnly = true;
    }
  }

  mettreAJourEtatResident();

  ui.conteneurFinalisation.classList.remove('hidden');
  ui.champEmailClient.focus();
}

/**
 * Détermine si le panier peut être validé automatiquement ou nécessite des informations complémentaires.
 * @param {Event} [ev]
 */
function initierValidationPanier(ev) {
  ev?.preventDefault?.();
  const { clientReconnu, panier } = window.etat;
  if (!obtenirCodePostalCourant()) {
    afficherNotification("Merci de valider le code postal de votre officine pour accéder à la réservation.", 'erreur');
    afficherVerrouCodePostal();
    return;
  }

  if (!panier || panier.length === 0) {
    afficherNotification("Votre panier est vide.", 'erreur');
    return;
  }

  if (clientReconnu && clientReconnu.email) {
    soumettreReservationClientReconnu();
  } else {
    afficherConteneurFinalisation();
  }
}

/**
 * Soumet la réservation en utilisant directement les informations du client reconnu.
 */
function soumettreReservationClientReconnu() {
  const { ui } = window;
  const { clientReconnu, panier } = window.etat;
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const codePostal = obtenirCodePostalCourant();

  if (!codePostal) {
    afficherNotification("Merci de valider le code postal de votre officine avant de finaliser.", 'erreur');
    afficherVerrouCodePostal();
    return;
  }
  if (!clientReconnu || !clientReconnu.email) {
    afficherNotification("Identifiez-vous pour finaliser votre réservation.", 'erreur');
    afficherConteneurFinalisation();
    return;
  }

  if (!panier || panier.length === 0) {
    afficherNotification("Votre panier est vide.", 'erreur');
    return;
  }

  const email = String(clientReconnu.email).trim();
  if (!emailRegex.test(email)) {
    afficherNotification("Votre email enregistré nécessite une vérification. Merci de le confirmer.", 'erreur');
    afficherConteneurFinalisation();
    return;
  }

  if (ui.champEmailClient) {
    ui.champEmailClient.value = email;
    ui.champEmailClient.readOnly = true;
  }
  if (ui.champNomClient) {
    ui.champNomClient.value = clientReconnu.nom || '';
    ui.champNomClient.readOnly = true;
  }
  if (ui.champAdresseClient) {
    ui.champAdresseClient.value = clientReconnu.adresse || '';
  }
  if (ui.champSiretClient) {
    ui.champSiretClient.value = clientReconnu.siret || '';
  }
  if (ui.champCodePostalClient) {
    ui.champCodePostalClient.value = codePostal;
    ui.champCodePostalClient.readOnly = true;
  }
  if (ui.champResidentClient) {
    ui.champResidentClient.checked = !!clientReconnu.resident;
  }

  const residentActif = estForfaitResidentActif() || !!clientReconnu.resident;
  const modeResident = (typeof obtenirModeResident === 'function') ? obtenirModeResident() : 'standard';

  const donneesReservation = {
    client: {
      email: email,
      contactEmail: email,
      nom: clientReconnu.nom || '',
      adresse: clientReconnu.adresse || '',
      siret: clientReconnu.siret || '',
      note: ui.champNoteReservation?.value.trim() || '',
      resident: residentActif,
      residentMode: modeResident,
      codePostal: codePostal
    },
    items: panier
  };

  soumettreReservation(donneesReservation, { skipBillingModal: true });
}

function mettreAJourEtatResident() {
    const { ui } = window;
    const actif = estForfaitResidentActif();
    const affiliationReq = !!(window.configServeur && window.configServeur.RESIDENT_AFFILIATION_REQUIRED);
    ui.blocResidentDetails?.classList.toggle('hidden', !actif);
    ui.residentNoticeCreneau?.classList.toggle('hidden', !actif);
    if (ui.champEmailClient) {
      ui.champEmailClient.required = true;
      ui.champEmailClient.placeholder = actif
        ? (affiliationReq ? "Email de la structure (requis)" : "Email de la structure")
        : "";
    }
    if (ui.clientEmailHelper) {
      if (actif) {
        ui.clientEmailHelper.textContent = affiliationReq
          ? "Renseignez l'email de la structure : il servira à recevoir l'identifiant d'accès au portail client."
          : "Nous utiliserons l'email de la structure pour envoyer l'identifiant d'accès client.";
      } else {
        ui.clientEmailHelper.textContent = "Cette adresse email est requise pour recevoir votre identifiant d'accès client.";
      }
    }
    if (!actif) {
      (ui.residentModeRadios || []).forEach(radio => {
        if (radio.value === 'standard') radio.checked = true;
      });
    }
    if (typeof afficherPanier === 'function') {
      afficherPanier();
    }
    if (typeof mettreAJourRecapSelectionResident === 'function') {
      mettreAJourRecapSelectionResident();
    }
}

/**
 * Envoie les données de réservation au serveur, en gérant les éventuels compléments (facturation).
 * @param {{client:Object,items:Array}} donneesReservation
 */
function soumettreReservation(donneesReservation, options = {}) {
  const { ui } = window;
  const skipBilling = options.skipBillingModal === true;
  const codePostalCourant = obtenirCodePostalCourant();
  if (!codePostalCourant) {
    afficherNotification("Merci de valider le code postal de votre officine avant de continuer.", 'erreur');
    afficherVerrouCodePostal();
    return;
  }
  if (donneesReservation && donneesReservation.client) {
    donneesReservation.client.codePostal = codePostalCourant;
  }

  function envoyer() {
    basculerIndicateurChargement(true);
    google.script.run
      .withSuccessHandler(reponse => {
        basculerIndicateurChargement(false);
        if (reponse.success) {
          afficherNotification("Réservation confirmée ! Un email vous a été envoyé.", 'succes');
          window.etat.panier = [];
          sauvegarderPanierDansLocalStorage();
          afficherPanier();
          ui.conteneurFinalisation.classList.add('hidden');
          memoriserClientReconnu(donneesReservation.client);
        } else {
          afficherErreur(reponse.summary || "Une erreur est survenue lors de la réservation.");
          if (reponse.failedItemIds && reponse.failedItemIds.length > 0) {
            window.etat.panier = window.etat.panier.filter(item => !reponse.failedItemIds.includes(item.id));
            sauvegarderPanierDansLocalStorage();
            afficherPanier();
          }
        }
      })
      .withFailureHandler(afficherErreur)
      .reserverPanier(donneesReservation);
  }

  if (!skipBilling && window.etat.flags.billingModalEnabled) {
    openBillingModal({ orderId: Date.now().toString(), billTo: 'resident', mode: 'existant' });
    const handler = () => {
      window.removeEventListener('billing:saved', handler);
      envoyer();
    };
    window.addEventListener('billing:saved', handler);
  } else {
    envoyer();
  }
}

/**
 * Gère la demande d'envoi de devis par email.
 */
function gererDemandeDevis() {
  const { ui } = window;
  const { panier, flags } = window.etat;

  if (flags?.devisEnabled === false) {
    afficherNotification('La demande de devis est désactivée.', 'info');
    return;
  }

  if (panier.length === 0) {
    afficherNotification('Votre panier est vide.', 'erreur');
    return;
  }

  let email = ui.champEmailClient?.value.trim();
  if (!email && window.etat.clientReconnu) {
    email = window.etat.clientReconnu.email;
  }

  if (email) {
    envoyerDevis(email);
  } else {
    document.getElementById('modale-email-devis')?.classList.remove('hidden');
  }
}

/**
 * Collecte les données et appelle le serveur pour envoyer le devis.
 * @param {string} email
 */
function envoyerDevis(email) {
  const { ui } = window;
  const { panier, flags } = window.etat;

  if (flags?.devisEnabled === false) {
    afficherNotification('La demande de devis est désactivée.', 'info');
    return;
  }

  basculerIndicateurChargement(true);

  const donneesDevis = {
    client: {
      email: email,
      nom: ui.champNomClient?.value.trim() || window.etat.clientReconnu?.nom || ''
    },
    items: panier
  };

  google.script.run
    .withSuccessHandler(reponse => {
      basculerIndicateurChargement(false);
      if (reponse.success) {
        afficherNotification(`Un devis a été envoyé à ${email}`, 'succes');
      } else {
        afficherErreur(reponse.error || "L'envoi du devis a échoué.");
      }
    })
    .withFailureHandler(afficherErreur)
    .envoyerDevisParEmail(donneesDevis);
}

/**
 * Ouvre la modale de coordonnées de facturation et gère la saisie.
 * @param {Object} opts
 */
function openBillingModal(opts = {}) {
  const modal = document.getElementById('modale-billing');
  if (!modal) return;
  const form = document.getElementById('formulaire-billing');
  const btnAnnuler = document.getElementById('btn-billing-annuler');
  const btnFermer = document.getElementById('btn-fermer-billing');
  const btnSwitch = document.getElementById('btn-billing-switch');
  let lastFocus = document.activeElement;

  function remplir(data) {
    form.billingNom.value = data.nom || '';
    form.billingAdresse.value = data.adresse || '';
    form.billingEmail.value = data.email || '';
    form.billingTelephone.value = data.telephone || '';
    form.billingSiret.value = data.siret || '';
    form.billingTva.value = data.tva || '';
  }

  if (opts.defaults) {
    remplir(opts.defaults);
  } else {
    google.script.run.withSuccessHandler(r => {
      if (r && r.defaults) remplir(r.defaults);
    }).doGetBillingDefaults(opts.orderId, opts.billTo, opts.ctx);
  }

  if (opts.mode === 'existant') {
    Array.from(form.elements).forEach(el => {
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
        el.readOnly = true;
      }
    });
    btnSwitch.classList.remove('hidden');
  } else {
    btnSwitch.classList.add('hidden');
  }

  function activerEdition() {
    Array.from(form.elements).forEach(el => {
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
        el.readOnly = false;
      }
    });
    btnSwitch.classList.add('hidden');
  }
  btnSwitch.addEventListener('click', activerEdition, { once: true });

  function fermer() {
    modal.classList.add('hidden');
    form.reset();
    btnSwitch.classList.add('hidden');
    modal.removeEventListener('keydown', trap);    
    if (lastFocus) lastFocus.focus();
  }

  btnAnnuler.addEventListener('click', fermer, { once: true });
  btnFermer.addEventListener('click', fermer, { once: true });

  form.addEventListener('submit', e => {
    e.preventDefault();
    const payload = {
      orderId: opts.orderId,
      billTo: opts.billTo,
      nom: form.billingNom.value.trim(),
      adresse: form.billingAdresse.value.trim(),
      email: form.billingEmail.value.trim(),
      telephone: form.billingTelephone.value.trim(),
      siret: form.billingSiret.value.trim(),
      tva: form.billingTva.value.trim()
    };
    google.script.run.withSuccessHandler(res => {
      if (res && res.success) {
        fermer();
        window.dispatchEvent(new CustomEvent('billing:saved', { detail: res }));
      } else {
        afficherNotification('Erreur lors de l\'enregistrement.', 'erreur');
      }
    }).doSaveBillingForOrder(payload);
  }, { once: true });

  function trap(ev) {
    if (ev.key === 'Escape') {
      fermer();
    }
    if (ev.key === 'Tab') {
      const focusables = modal.querySelectorAll('button, [href], input, textarea, select, [tabindex]:not([tabindex="-1"])');
      const list = Array.prototype.filter.call(focusables, el => !el.disabled && el.offsetParent !== null);
      if (list.length === 0) return;
      const first = list[0];
      const last = list[list.length - 1];
      if (ev.shiftKey && document.activeElement === first) {
        ev.preventDefault();
        last.focus();
      } else if (!ev.shiftKey && document.activeElement === last) {
        ev.preventDefault();
        first.focus();
      }
    }
  }
  modal.addEventListener('keydown', trap);

  modal.classList.remove('hidden');
  const firstField = modal.querySelector('input, textarea, select, button');
  if (firstField) firstField.focus();
}

/**

 * Gère la soumission du formulaire de réservation final.
 * @param {SubmitEvent} e
 */
function gererSoumissionReservation(e) {
  e.preventDefault();
  const { ui } = window;
  const { panier } = window.etat;
  const codePostal = obtenirCodePostalCourant();

  if (panier.length === 0) {
    afficherNotification("Votre panier est vide.", 'erreur');
    return;
  }

  if (!codePostal) {
    afficherNotification("Merci de valider le code postal de votre officine avant de finaliser.", 'erreur');
    afficherVerrouCodePostal();
    return;
  }

  const emailSaisi = ui.champEmailClient.value.trim();
  const emailClient = (emailSaisi || window.etat.clientReconnu?.email || '').trim();
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const isResident = estForfaitResidentActif();
  const residentMode = obtenirModeResident();
  if (!emailClient) {
    afficherNotification('Merci de renseigner une adresse email valide pour recevoir votre identifiant.', 'erreur');
    ui.champEmailClient.focus();
    return;
  }
  if (!emailRegex.test(emailClient)) {
    afficherNotification("Veuillez fournir une adresse email valide.", 'erreur');
    ui.champEmailClient.focus();
    return;
  }
  if (!emailSaisi) {
    ui.champEmailClient.value = emailClient;
  }
  if (ui.champCodePostalClient) {
    ui.champCodePostalClient.value = codePostal;
    ui.champCodePostalClient.readOnly = true;
  }

  const donneesReservation = {
    client: {
      email: emailClient,
      contactEmail: emailClient,
      nom: ui.champNomClient.value.trim(),
      adresse: ui.champAdresseClient.value.trim(),
      siret: ui.champSiretClient.value.trim(),
      note: ui.champNoteReservation.value.trim(),
      resident: isResident,
      residentMode: residentMode,
      codePostal: codePostal
    },
    items: panier
  };
  if (window.etat.flags.adresseAutocompleteEnabled && window.etat.adresseSuggestion) {
    const selection = window.etat.adresseSuggestion;
    if (selection && selection.label && selection.label === donneesReservation.client.adresse) {
      donneesReservation.client.adresseSuggestion = selection;
    }
  }

  soumettreReservation(donneesReservation);
}

/**
 * Affiche ou masque le bouton "Vider Panier" et gère son écouteur.
 */
function mettreAJourBoutonViderPanier() {
  const { ui } = window;

  ui.btnViderPanier?.removeEventListener('click', viderPanier);
  if (window.etat.flags.cartResetEnabled) {
    ui.btnViderPanier?.classList.remove('hidden');
    ui.btnViderPanier?.addEventListener('click', viderPanier);
  } else {
    ui.btnViderPanier?.classList.add('hidden');
  }
}

/**
 * Configure tous les écouteurs d'événements de l'application.
 */
function configurerEcouteursEvenements() {
  const { ui } = window;

  // Gère les clics sur les jours du calendrier.
  ui.grilleCalendrier?.addEventListener('click', (e) => {
    const jourClique = e.target.closest('.jour-calendrier');
    if (jourClique && !jourClique.classList.contains('desactive')) {
      const dateString = jourClique.dataset.date;
      if(dateString) {
        ouvrirConfigurationTournee(dateString);
      }
    }
  });

  // Navigation du calendrier
  ui.btnMoisPrecedent?.addEventListener('click', () => changerMois(-1));
  ui.btnMoisSuivant?.addEventListener('click', () => changerMois(1));

  // Écouteur pour le formulaire de configuration de tournée
  ui.formulaireConfigTournee?.addEventListener('submit', gererDemandeCreneaux);

  // Actions de la modale de configuration (Modale 1)
  ui.btnFermerConfigTournee?.addEventListener('click', () => ui.modaleConfigTournee.classList.add('hidden'));
  ui.btnAjouterArret?.addEventListener('click', () => {
    ui.valeurArretsSup.textContent = parseInt(ui.valeurArretsSup.textContent) + 1;
    mettreAJourResumeTournee();
  });
  ui.btnRetirerArret?.addEventListener('click', () => {
    const valeur = parseInt(ui.valeurArretsSup.textContent);
    if (valeur > 1) {
      ui.valeurArretsSup.textContent = valeur - 1;
      mettreAJourResumeTournee();
    }
  });
  ui.interrupteurRetour?.addEventListener('change', mettreAJourResumeTournee);

  // Actions de la modale de sélection de créneau (Modale 2)
  ui.btnFermerSelectionCreneau?.addEventListener('click', () => ui.modaleSelectionCreneau.classList.add('hidden'));
  ui.btnAjouterAuPanier?.addEventListener('click', gererAjoutAuPanier);
  ui.btnModifierTournee?.addEventListener('click', retourVersConfiguration);

  // Écouteurs pour la modale de confirmation de récurrence (Modale 3)
  const modaleRecurrence = document.getElementById('modale-confirmation-recurrence');
  document.getElementById('btn-confirmer-recurrence')?.addEventListener('click', confirmerEtAjouterRecurrenceAuPanier);
  document.getElementById('btn-fermer-confirmation-recurrence')?.addEventListener('click', () => modaleRecurrence.classList.add('hidden'));
  document.getElementById('btn-annuler-recurrence')?.addEventListener('click', () => modaleRecurrence.classList.add('hidden'));

  // Actions du panier et de la finalisation
  ui.btnValiderPanier?.addEventListener('click', initierValidationPanier);
  document.getElementById('btn-envoyer-devis')?.addEventListener('click', gererDemandeDevis);
  ui.formulaireReservation?.addEventListener('submit', gererSoumissionReservation);
  ui.btnAnnulerReservation?.addEventListener('click', () => ui.conteneurFinalisation.classList.add('hidden'));
  ui.listePanier?.addEventListener('click', gererActionsPanier);
  mettreAJourBoutonViderPanier();

  ui.champResidentClient?.addEventListener('change', mettreAJourEtatResident);
  (ui.residentModeRadios || []).forEach(radio => {
    radio.addEventListener('change', () => {
      if (estForfaitResidentActif()) mettreAJourEtatResident();
    });
  });

  window.addEventListener('billing:saved', () => {
    afficherNotification('Coordonnées de facturation enregistrées.', 'succes');
  });

  // Écouteurs pour la modale de demande d'email pour le devis
  const modaleEmailDevis = document.getElementById('modale-email-devis');
  document.getElementById('formulaire-email-devis')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const emailInput = document.getElementById('email-pour-devis');
      if (emailInput && emailInput.value) {
          envoyerDevis(emailInput.value.trim());
          modaleEmailDevis.classList.add('hidden');
          emailInput.value = '';
      }
  });
  document.getElementById('btn-fermer-email-devis')?.addEventListener('click', () => {
      modaleEmailDevis.classList.add('hidden');
  });

  // Gestion du client
  ui.champEmailClient?.addEventListener('blur', (e) => {
      if(e.target.value) {
          preRemplirInfosClient(e.target.value);
      }
  });
  ui.btnChangerClient?.addEventListener('click', reinitialiserClient);
  ui.btnConnexionClient?.addEventListener('click', demanderConnexionClient);
}

/**
 * Point d'entrée principal, exécuté après le chargement du DOM.
 */
document.addEventListener('DOMContentLoaded', () => {
  initialiserVerrouCodePostal();
  google.script.run.withSuccessHandler(cfg => {
    window.etat.flags = initializeFlags(cfg);
    initialiserTarifsResident();
    if (typeof initialiserAdresseAutocompleteClient === 'function') {
      initialiserAdresseAutocompleteClient();
    }
    mettreAJourEtatResident();
    try {
      if (window.etat.flags && window.etat.flags.elsUiThemingEnabled) {
        document.body.classList.add('els-ui-theming');
        document.body.classList.add('els-aluminium'); // QA: fond aluminium activé
      }
    } catch (e) { /* no-op */ }
    mettreAJourBoutonViderPanier();
    configurerEcouteursEvenements();
  }).getConfiguration();
  chargerPanierDepuisLocalStorage();
  verifierSessionClient();
  afficherCalendrier(window.etat.dateActuelle.getMonth() + 1, window.etat.dateActuelle.getFullYear());
});

/**
 * Change le mois affiché dans le calendrier.
 * @param {number} delta - Le changement de mois (-1 pour précédent, 1 pour suivant).
 */
function changerMois(delta) {
    window.etat.dateActuelle.setMonth(window.etat.dateActuelle.getMonth() + delta);
    afficherCalendrier(window.etat.dateActuelle.getMonth() + 1, window.etat.dateActuelle.getFullYear());
}
</script>



