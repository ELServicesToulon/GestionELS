<!DOCTYPE html>
<html lang="fr">
<head>
  <? var appUrl = ScriptApp.getService().getUrl(); var nomService = NOM_ENTREPRISE; ?>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Livraison pharmacie à domicile et EHPAD sur Tamaris, Mar Vivo, Six-Fours-les-Plages, Sanary, Portissol et Bandol.">
  <link rel="canonical" href="<?= appUrl ?>">
  <meta property="og:title" content="<?= nomService ?> | Panneau de Débogage">
  <meta property="og:description" content="Livraison pharmacie à domicile et EHPAD sur Tamaris, Mar Vivo, Six-Fours-les-Plages, Sanary, Portissol et Bandol.">
  <meta property="og:url" content="<?= appUrl ?>">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="<?= nomService ?> | Panneau de Débogage">
  <meta name="twitter:description" content="Livraison pharmacie à domicile et EHPAD sur Tamaris, Mar Vivo, Six-Fours-les-Plages, Sanary, Portissol et Bandol.">
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "LocalBusiness",
        "@id": "<?= appUrl ?>#business",
        "name": "<?= nomService ?>",
        "description": "Livraison pharmacie à domicile et EHPAD sur Tamaris, Mar Vivo, Six-Fours-les-Plages, Sanary, Portissol et Bandol.",
        "url": "<?= appUrl ?>",
        "email": "<?= EMAIL_ENTREPRISE ?>",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Six-Fours-les-Plages",
          "addressCountry": "FR"
        },
        "geo": {
          "@type": "GeoCoordinates",
          "latitude": 43.0842,
          "longitude": 5.8009
        },
        "areaServed": [
          { "@type": "Place", "name": "Tamaris" },
          { "@type": "Place", "name": "Mar Vivo" },
          { "@type": "Place", "name": "Six-Fours-les-Plages" },
          { "@type": "Place", "name": "Sanary" },
          { "@type": "Place", "name": "Portissol" },
          { "@type": "Place", "name": "Bandol" }
        ]
      },
      {
        "@type": "Service",
        "@id": "<?= appUrl ?>#service",
        "serviceType": "Livraison de pharmacie",
        "provider": { "@id": "<?= appUrl ?>#business" },
        "areaServed": [
          { "@type": "Place", "name": "Tamaris" },
          { "@type": "Place", "name": "Mar Vivo" },
          { "@type": "Place", "name": "Six-Fours-les-Plages" },
          { "@type": "Place", "name": "Sanary" },
          { "@type": "Place", "name": "Portissol" },
          { "@type": "Place", "name": "Bandol" }
        ]
      }
    ]
  }
  </script>
  <title><?= nomService ?> | Panneau de Débogage</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
        body { font-family: Montserrat, sans-serif; margin: 20px; background-color: #0b0e13; color: #fff; }
        .app-logo-container { display: flex; justify-content: center; align-items: center; margin: 0 0 20px; }
        .app-logo-container svg { max-width: 200px; height: auto; }
        h1 { color: #fff; }
        .test-suite { background-color: #0f151f; border: 1px solid #1d2a3a; border-radius: 5px; padding: 15px; margin-bottom: 15px; }
        button { background: linear-gradient(135deg, #8e44ad, #3498db); color: #fff; border: none; padding: 10px 18px; border-radius: 9999px; cursor: pointer; margin-right: 10px; box-shadow: 0 6px 18px rgba(0,0,0,.18); transition: transform .08s ease, box-shadow .2s ease; }
        button:hover { transform: translateY(-1px); }
        button:focus { outline: 2px solid #3498db; outline-offset: 2px; }
        button:active { transform: translateY(0); }
        #results { margin-top: 20px; background-color: #101724; color: #fff; padding: 15px; border-radius: 5px; white-space: pre-wrap; font-family: monospace; height: 400px; overflow-y: scroll; }
    </style>
  <?!= include('charte'); ?>
  <?!= include('GoogleChartsStub'); ?>
</head>
<body>
    <?!= include('Logo'); ?>
    <h1>Panneau de Débogage</h1>

  <div class="test-suite">
    <h3>Tests Complets</h3>
    <p>Lance l'ensemble des tests du back-office. Les résultats s'afficheront dans la console ci-dessous et dans les journaux Apps Script.</p>
    <button id="btn-run-all">Lancer tous les tests</button>
  </div>

  <div class="test-suite">
    <h3>Générer un lien Espace Client</h3>
    <p>Crée un lien signé pour accéder à l'espace client (admin requis).</p>
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
      <input type="email" id="email-client" placeholder="client@example.com" style="flex:1; min-width:260px; padding:8px; border-radius:6px; border:1px solid #1d2a3a; background:#0b0e13; color:#fff">
      <input type="number" id="validite-heures" value="168" min="1" step="1" style="width:120px; padding:8px; border-radius:6px; border:1px solid #1d2a3a; background:#0b0e13; color:#fff">
      <button id="btn-generer">Générer</button>
    </div>
    <div id="zone-lien" style="margin-top:10px; display:none">
      <input type="text" id="lien-resultat" readonly style="width:100%; padding:8px; border-radius:6px; border:1px solid #1d2a3a; background:#0b0e13; color:#fff">
      <div style="margin-top:8px"><button id="btn-copier">Copier</button></div>
    </div>
  </div>
    
    <div id="results">
        Cliquez sur un bouton pour lancer les tests...
    </div>

    <script>
    document.getElementById('btn-run-all').addEventListener('click', () => {
      document.getElementById('results').textContent = 'Lancement des tests... Veuillez patienter.';
      google.script.run
        .withSuccessHandler(logs => {
          document.getElementById('results').textContent = "Tests terminés !\n\n" + logs;
        })
        .withFailureHandler(err => {
          document.getElementById('results').textContent = "Une erreur est survenue : " + err.message;
        })
        .lancerTousLesTestsEtRetournerLogs();
    });

    document.getElementById('btn-generer').addEventListener('click', () => {
      const email = String(document.getElementById('email-client').value || '').trim();
      const heures = parseInt(document.getElementById('validite-heures').value || '168', 10);
      if (!email) { document.getElementById('results').textContent = 'Email requis'; return; }
      document.getElementById('results').textContent = 'Génération du lien...';
      google.script.run
        .withSuccessHandler(res => {
          if (res && res.url) {
            const zone = document.getElementById('zone-lien');
            zone.style.display = 'block';
            const input = document.getElementById('lien-resultat');
            input.value = res.url;
            document.getElementById('results').textContent = 'Lien généré. Expire le ' + new Date(res.exp*1000).toLocaleString();
          } else {
            document.getElementById('results').textContent = 'Échec de génération.';
          }
        })
        .withFailureHandler(err => {
          document.getElementById('results').textContent = 'Erreur: ' + err.message;
        })
        .genererLienEspaceClient(email, heures);
    });

    document.getElementById('btn-copier').addEventListener('click', () => {
      const input = document.getElementById('lien-resultat');
      input.select();
      try { document.execCommand('copy'); } catch (e) {}
    });
    </script>
</body>
</html>
