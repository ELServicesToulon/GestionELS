<script>
/**
 * Fonctions utilitaires de tarification pour le client.
 */
function computeSupplementCost(nSupp) {
  const arr = configServeur?.TARIFS?.Normal?.arrets || [];
  const fallback = arr.length ? arr[arr.length - 1] : 0;
  let sum = 0;
  for (let i = 0; i < nSupp; i++) sum += (i < arr.length ? arr[i] : fallback);
  return sum;
}

function computeCoursePrice(opts = {}) {
  const {
    totalStops = 1,
    retour = false,
    urgent = false,
    samedi = false,
    remise = 0
  } = opts;

  const nbSupp = Math.max(0, (totalStops | 0) - 1);
  const base = configServeur?.TARIFS?.Normal?.base || 0;
  if (!configServeur?.TARIFS?.Normal?.base) {
    return {
      total: 0,
      nbSupp,
      error: 'Tarif Normal.base manquant',
      breakdown: { base: 0, supplements: 0, retour: 0, urgent: 0, samedi: 0, remise }
    };
  }
  const supplements = computeSupplementCost(nbSupp);
  const retourFee = retour ? (computeSupplementCost(nbSupp + 1) - supplements) : 0;
  const urgentBase = configServeur?.TARIFS?.Urgent?.base || 0;
  if (urgent && !configServeur?.TARIFS?.Urgent?.base) {
    return {
      total: 0,
      nbSupp,
      error: 'Tarif Urgent.base manquant',
      breakdown: { base, supplements, retour: retourFee, urgent: 0, samedi: 0, remise }
    };
  }
  const surcUrg = urgent ? (urgentBase - base) : 0;
  const samediBase = configServeur?.TARIFS?.Samedi?.base || 0;
  if (samedi && !configServeur?.TARIFS?.Samedi?.base) {
    return {
      total: 0,
      nbSupp,
      error: 'Tarif Samedi.base manquant',
      breakdown: { base, supplements, retour: retourFee, urgent: surcUrg, samedi: 0, remise }
    };
  }
  const surcSam = samedi ? (samediBase - base) : 0;

  let total = base + supplements + retourFee + surcUrg + surcSam - remise;

  return {
    total,
    nbSupp,
    breakdown: { base, supplements, retour: retourFee, urgent: surcUrg, samedi: surcSam, remise }
  };
}
</script>
