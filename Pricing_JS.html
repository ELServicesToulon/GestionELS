<script>
/**
 * Fonctions utilitaires de tarification pour le client.
 */
function computeSupplementCost(nSupp) {
  const arr = configServeur?.TARIFS?.normal?.arrets || [];
  const fallback = arr.length ? arr[arr.length - 1] : 0;
  let sum = 0;
  for (let i = 0; i < nSupp; i++) sum += (i < arr.length ? arr[i] : fallback);
  return sum;
}

function computeCoursePrice(opts = {}) {
  const {
    totalStops = 1,
    retour = false,
    urgent = false,
    samedi = false,
    precollecte = false,
    remise = 0
  } = opts;

  const applyV2 = !!(typeof configServeur !== 'undefined' && configServeur.PRICING_RULES_V2_ENABLED);
  const isSamedi = !!samedi;
  const isUrgent = !!urgent && (!applyV2 || !isSamedi);

  const nbSupp = Math.max(0, (totalStops | 0) - 1);
  const base = configServeur?.TARIFS?.normal?.base || 0;
  if (!configServeur?.TARIFS?.normal?.base) {
    return {
      total: 0,
      nbSupp,
      error: 'Tarif normal.base manquant',
      breakdown: { base: 0, supplements: 0, retour: 0, urgent: 0, samedi: 0, precollecte: 0, remise }
    };
  }
  const supplements = computeSupplementCost(nbSupp);
  const retourFee = retour ? (computeSupplementCost(nbSupp + 1) - supplements) : 0;
  const surcharges = configServeur?.TARIFS?.surcharges || {};
  const surcUrg = isUrgent ? (surcharges.URGENT || 0) : 0;
  const surcSam = isSamedi ? (surcharges.SAMEDI || 0) : 0;
  const surcPre = precollecte ? (surcharges.PRECOLLECTE || 0) : 0;

  const total = base + supplements + retourFee + surcUrg + surcSam + surcPre - remise;

  return {
    total,
    nbSupp,
    breakdown: { base, supplements, retour: retourFee, urgent: surcUrg, samedi: surcSam, precollecte: surcPre, remise }
  };
}
</script>
