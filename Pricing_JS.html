<script>
/**
 * Fonctions utilitaires de tarification pour le client.
 */
function computeSupplementCost(nSupp) {
  const arr = (typeof configServeur !== 'undefined' && configServeur.TARIFS && configServeur.TARIFS.Normal && configServeur.TARIFS.Normal.arrets)
    ? configServeur.TARIFS.Normal.arrets
    : [];
  const fallback = arr.length ? arr[arr.length - 1] : 0;
  let sum = 0;
  for (let i = 0; i < nSupp; i++) sum += (i < arr.length ? arr[i] : fallback);
  return sum;
}

function computeCoursePrice(opts = {}) {
  const {
    totalStops = 1,
    retour = false,
    urgent = false,
    samedi = false,
    remise = 0
  } = opts;

  const nbSupp = Math.max(0, (totalStops | 0) - 1);
  const base = configServeur.TARIFS.Normal.base;
  const supplements = computeSupplementCost(nbSupp);
  const retourFee = retour ? (computeSupplementCost(nbSupp + 1) - supplements) : 0;
  const surcUrg = urgent ? (configServeur.TARIFS.Urgent.base - base) : 0;
  const surcSam = samedi ? (configServeur.TARIFS.Samedi.base - base) : 0;

  let total = base + supplements + retourFee + surcUrg + surcSam - remise;

  return {
    total,
    nbSupp,
    breakdown: { base, supplements, retour: retourFee, urgent: surcUrg, samedi: surcSam, remise }
  };
}
</script>
