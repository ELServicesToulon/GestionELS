<script>
(function () {
  'use strict';

  const CHAT_SESSION_KEY = 'ELS_CHAT_SESSION_ID';
  const POLL_INTERVAL_MS = 6000;

  function generateSessionId() {
    try {
      if (window.crypto && window.crypto.getRandomValues) {
        const bytes = new Uint8Array(16);
        window.crypto.getRandomValues(bytes);
        return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
      }
    } catch (_err) {
      // Ignore and fall back.
    }
    return (Math.random().toString(16).slice(2) + Date.now().toString(16)).substring(0, 32);
  }

  function ensureSessionId() {
    try {
      const existing = sessionStorage.getItem(CHAT_SESSION_KEY);
      if (existing && existing.length >= 8) {
        return existing;
      }
      const fresh = generateSessionId();
      sessionStorage.setItem(CHAT_SESSION_KEY, fresh);
      return fresh;
    } catch (_err) {
      if (!window.__elsChatSessionId) {
        window.__elsChatSessionId = generateSessionId();
      }
      return window.__elsChatSessionId;
    }
  }

  function renderMessageContent(container, text) {
    const safeText = typeof text === 'string' ? text : '';
    const fragments = safeText.split(/\r?\n/);
    fragments.forEach((line, index) => {
      if (index > 0) {
        container.appendChild(document.createElement('br'));
      }
      container.appendChild(document.createTextNode(line));
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const stream = document.getElementById('chatStream');
    const form = document.getElementById('chatForm');
    const refreshBtn = document.getElementById('refreshChat');
    const filterPharmacy = document.getElementById('onlyPharmacy');
    const demandeForm = document.getElementById('demandeForm');
    const demandeOk = document.getElementById('demandeOk');

    if (!stream || !form) {
      return;
    }
    if (!window.google || !google.script || !google.script.run) {
      console.warn('[ELS] google.script.run est indisponible, le chat est désactivé.');
      return;
    }

    const sessionId = ensureSessionId();
    const authorTypeEl = document.getElementById('authorType');
    const messageEl = document.getElementById('chatMessage');
    const codeEl = document.getElementById('pharmacyCode');
    const submitBtn = form.querySelector('button[type="submit"]');

    let lastTimestamp = 0;
    let isLoading = false;
    const renderedKeys = new Set();

    function keyForMessage(msg) {
      const ts = String(msg.timestamp || '');
      const thread = msg.threadId || 'default';
      return `${thread}:${ts}`;
    }

    function createMessageElement(msg) {
      const article = document.createElement('article');
      const isAdmin = String(msg.authorType || '').toLowerCase() === 'admin';
      article.className = 'els-chat__msg' + (isAdmin ? ' els-chat__msg--admin' : '');

      const meta = document.createElement('div');
      meta.className = 'els-chat__meta';
      const ts = Number(msg.timestamp) || Date.now();
      const date = new Date(ts);
      const authorLabel = isAdmin ? 'Admin' : (msg.authorPseudo || 'Pharmacie');
      meta.textContent = `${authorLabel} • ${date.toLocaleString('fr-FR')}`;

      const body = document.createElement('div');
      body.className = 'els-chat__body';
      renderMessageContent(body, msg.message || '');

      article.appendChild(meta);
      article.appendChild(body);
      return article;
    }

    function renderMessages(list, reset) {
      if (reset) {
        stream.innerHTML = '';
        renderedKeys.clear();
      }
      list.forEach(msg => {
        if (filterPharmacy.checked && String(msg.authorType || '').toLowerCase() === 'admin') {
          return;
        }
        const key = keyForMessage(msg);
        if (renderedKeys.has(key)) {
          return;
        }
        renderedKeys.add(key);
        stream.appendChild(createMessageElement(msg));
      });
      if (list.length) {
        stream.scrollTop = stream.scrollHeight;
      }
    }

    function loadMessages(reset) {
      if (isLoading) return;
      isLoading = true;
      const since = reset ? 0 : lastTimestamp;
      google.script.run
        .withSuccessHandler(response => {
          isLoading = false;
          if (!response || !Array.isArray(response.messages)) return;
          renderMessages(response.messages, reset);
          if (response.lastTs && Number(response.lastTs) > lastTimestamp) {
            lastTimestamp = Number(response.lastTs);
          }
        })
        .withFailureHandler(err => {
          isLoading = false;
          console.warn('[ELS] Erreur lors du chargement du chat', err);
        })
        .chatGetMessages({ since: since, audience: 'pharmacy' });
    }

    loadMessages(true);
    setInterval(() => loadMessages(false), POLL_INTERVAL_MS);

    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => loadMessages(true));
    }
    if (filterPharmacy) {
      filterPharmacy.addEventListener('change', () => loadMessages(true));
    }

    form.addEventListener('submit', event => {
      event.preventDefault();
      if (!messageEl || !authorTypeEl) return;
      const message = (messageEl.value || '').trim();
      if (!message.length) return;

      const payload = {
        authorType: authorTypeEl.value || 'pharmacy',
        message: message,
        pharmacyCode: codeEl ? (codeEl.value || '').trim() : null,
        visibleTo: (authorTypeEl.value === 'admin') ? 'admin' : 'pharmacy',
        sessionId: sessionId
      };

      if (submitBtn) submitBtn.disabled = true;
      google.script.run
        .withSuccessHandler(result => {
          if (submitBtn) submitBtn.disabled = false;
          if (result && result.ok) {
            messageEl.value = '';
            if (codeEl) codeEl.value = '';
            loadMessages(true);
          } else {
            const reason = result && result.reason;
            if (reason === 'INVALID_CODE') {
              alert('Merci de saisir un code client pharmacie valide (4 à 8 caractères).');
            } else if (reason === 'RATE_LIMIT') {
              alert('Trop de messages envoyés en peu de temps. Patientez quelques instants.');
            } else {
              alert('Envoi refusé. Vérifiez votre message ou réessayez plus tard.');
            }
          }
        })
        .withFailureHandler(err => {
          if (submitBtn) submitBtn.disabled = false;
          console.error('[ELS] Erreur lors de l\'envoi du message', err);
          alert('Impossible d\'envoyer le message pour le moment.');
        })
        .chatPostMessage(payload);
    });

    if (demandeForm) {
      demandeForm.addEventListener('submit', event => {
        event.preventDefault();
        const data = {
          etabType: (document.getElementById('etabType')?.value || '').trim(),
          etabNom: (document.getElementById('etabNom')?.value || '').trim(),
          email: (document.getElementById('email')?.value || '').trim(),
          tel: (document.getElementById('tel')?.value || '').trim(),
          adresse: (document.getElementById('adresse')?.value || '').trim(),
          jours: (document.getElementById('jours')?.value || '').trim(),
          plage: (document.getElementById('plage')?.value || '').trim(),
          details: (document.getElementById('details')?.value || '').trim()
        };

        if (!data.etabNom || !data.email) {
          alert('Merci de renseigner le nom de l’établissement et l’email de contact.');
          return;
        }

        google.script.run
          .withSuccessHandler(result => {
            if (result && result.ok) {
              demandeForm.reset();
              if (demandeOk) {
                demandeOk.classList.remove('visually-hidden');
                setTimeout(() => demandeOk.classList.add('visually-hidden'), 8000);
              }
            } else {
              alert('Impossible d\'enregistrer la demande. Vérifiez vos informations.');
            }
          })
          .withFailureHandler(err => {
            console.error('[ELS] Erreur lors de l\'envoi de la demande tournée', err);
            alert('Une erreur est survenue pendant l\'enregistrement de la demande.');
          })
          .tourneeSubmitDemande(data);
      });
    }
  });
})();
</script>
