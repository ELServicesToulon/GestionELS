<script>
  /**
   * LEGACY SHIM — TODO: remove once all deployments use the new UI.
   * Provides inert stubs for legacy global initializers and overwrites
   * any existing implementations to prevent side effects.
   */
  (function (global) {
    [
      'basculerIndicateurChargement',
      'initialiser',
      'initialiserInterface',
      'initCalendrier',
      'initPanier',
      'initReservation'
    ].forEach(function (name) {
      global[name] = function () {};
    });
  })(this);
</script>
<style>
    :root{
      --violet:#8e44ad;
      --blue:#3498db;
      --blue-200:#5dade2;
      --text:#1b1f24;
      --muted:#6b7280;
      --bg:#ffffff;
      --bg-alt:#f7f8fa;
      --radius:16px;
      --focus: 3px solid #111827;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }
    header{
      position:sticky;top:0;z-index:10;
      background:linear-gradient(90deg,var(--violet),var(--blue));
      color:#fff;padding:14px 16px;
      box-shadow:0 2px 12px rgba(0,0,0,.08);
    }
    header h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.2px}
    main{padding:16px;max-width:980px;margin:0 auto}
    .toolbar{
      display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;margin-bottom:16px
    }
    .pill{
      --hpad:14px; --vpad:10px;
      appearance:none;border:0;border-radius:999px;
      padding:var(--vpad) var(--hpad);font-weight:600;font-size:14px;cursor:pointer;
      background:var(--violet);color:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06);
    }
    .pill.secondary{background:var(--blue)}
    .pill.ghost{background:transparent;border:2px solid var(--blue);color:var(--blue)}
    .pill:focus-visible{outline:var(--focus);outline-offset:2px}
    .field{
      display:flex;gap:8px;align-items:center;background:var(--bg-alt);
      border-radius:999px;padding:6px 10px
    }
    .field input[type="date"]{border:0;background:transparent;font:inherit;outline:none;padding:6px}
    .toggle{
      display:inline-flex;border:2px solid var(--blue);border-radius:999px;overflow:hidden
    }
    .toggle button{
      background:#fff;color:var(--blue);padding:8px 14px;border:0;cursor:pointer;font-weight:600
    }
    .toggle button[aria-pressed="true"]{background:var(--blue);color:#fff}
    .card{
      background:#fff;border-radius:var(--radius);
      box-shadow:0 6px 20px rgba(17,24,39,.06);padding:14px
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .toast{
      position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:12px 14px;border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);max-width:90vw
    }
    .link{color:var(--blue);text-decoration:none;font-weight:600}
    .link:focus-visible{outline:var(--focus)}
    /* ——— PILLBOX ——— */
    .pillbox-wrap{margin-top:16px}
    .pillbox{display:grid;grid-template-columns:100px repeat(4,1fr);gap:10px}
    .pillbox-head{display:contents}
    .pillbox-head .ph{font-weight:700;color:var(--text);opacity:.8;text-align:center}
    .pillbox-day{display:flex;align-items:center;justify-content:flex-start;font-weight:700;color:var(--violet);padding:6px 8px}
    .pillbox-slot{position:relative;min-height:72px;border-radius:16px;background:var(--bg-alt);
      box-shadow:inset 0 0 0 2px rgba(52,152,219,.15);display:flex;align-items:center;justify-content:center;cursor:pointer;outline:none}
    .pillbox-slot:focus-visible{outline:var(--focus);outline-offset:2px}
    .pillbox-slot[data-state="full"]{box-shadow:inset 0 0 0 2px var(--violet)}
    .pillbox-slot[data-state="busy"]{box-shadow:inset 0 0 0 2px var(--blue)}
    .pillbox-slot[data-fill]{color:#fff;background:linear-gradient(135deg,var(--violet),var(--blue));opacity:calc(.35 + var(--fill)*.65)}
    .slot-label{font-size:13px;font-weight:700;letter-spacing:.2px;background:#fff;border-radius:999px;padding:4px 10px;box-shadow:0 1px 0 rgba(0,0,0,.06)}
    .pillbox-legend{display:flex;gap:10px;align-items:center;margin-top:10px;color:var(--muted);font-size:13px}
    .pillbox-dot{width:10px;height:10px;border-radius:50%}
    .pillbox-dot.free{background:var(--bg-alt);box-shadow:inset 0 0 0 2px rgba(52,152,219,.15)}
    .pillbox-dot.busy{background:var(--blue)}
    .pillbox-dot.full{background:var(--violet)}
    /* ——— MODAL ——— */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
    .modal[hidden]{display:none}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35)}
    .modal-card{position:relative;background:#fff;border-radius:16px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.2);max-width:480px;width:92vw;max-height:80vh;overflow:auto}
    .time-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    .time-btn{border:2px solid var(--blue);background:#fff;border-radius:999px;padding:8px 10px;font-weight:600;cursor:pointer}
    .time-btn[disabled]{opacity:.5;cursor:not-allowed}
    .time-btn.selected{background:var(--blue);color:#fff}
  </style>
  <header>
    <h1 aria-live="polite">Réservation livraison — ELS</h1>
  </header>

  <main>
    <div class="toolbar" role="region" aria-label="Filtres et actions">
      <div class="field" role="group" aria-label="Date de consultation">
        <span class="sr-only" id="date-label">Date</span>
        <input id="dateControl" type="date" aria-labelledby="date-label">
      </div>
    </div>

    <section class="card pillbox-wrap" aria-labelledby="pillboxTitle">
      <h2 id="pillboxTitle" class="sr-only">Semainier (Matin, Midi, Après-midi, Soir)</h2>

      <div class="pillbox" id="pillbox" role="grid" aria-describedby="pillboxHelp">
        <!-- En-têtes colonnes -->
        <div class="pillbox-head" role="row">
          <div></div>
          <div class="ph" role="columnheader" aria-label="Matin">Matin</div>
          <div class="ph" role="columnheader" aria-label="Midi">Midi</div>
          <div class="ph" role="columnheader" aria-label="Après-midi">Après-midi</div>
          <div class="ph" role="columnheader" aria-label="Soir">Soir</div>
        </div>
        <!-- Les 7 lignes sont injectées en JS -->
      </div>

      <div id="pillboxHelp" class="pillbox-legend">
        <span class="pillbox-dot free" aria-hidden="true"></span> Dispo
        <span class="pillbox-dot busy" aria-hidden="true"></span> Occupé
        <span class="pillbox-dot full" aria-hidden="true"></span> Complet
      </div>
    </section>

    <!-- MODAL choix horaire -->
    <div id="timeModal" class="modal" hidden aria-modal="true" role="dialog" aria-labelledby="timeTitle">
      <div class="modal-backdrop" data-close></div>
      <div class="modal-card">
        <h3 id="timeTitle" style="margin:0 0 8px 0;">Choisir l’horaire</h3>
        <div id="timeList" class="time-grid" role="listbox" aria-label="Horaires disponibles"></div>
        <div class="row" style="margin-top:12px;">
          <button id="btnCancelTime" class="pill ghost" type="button">Annuler</button>
          <button id="btnConfirmTime" class="pill secondary" type="button" disabled aria-disabled="true">Valider</button>
        </div>
      </div>
    </div>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite" hidden></div>

  <noscript>
    <p>JavaScript est requis pour cette application.</p>
  </noscript>

  <script>
    /**
     * Brancher côté serveur (Code.gs) :
     * function getInitialModel(dateIso){ return { now: Date.now(), date: dateIso, slots: [], ampmEnabled: true }; }
     * function listSlots(dateIso, half){ return { date: dateIso, half, slots: [/* ... */] }; }
     * function createReservation(payload){ return { ok:true, id: 'RES-'+Date.now() }; }
     */

    const $$ = (sel, root=document) => root.querySelector(sel);
    const $all = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const toast = (msg) => {
      const el = $$('#toast');
      el.textContent = msg;
      el.hidden = false;
      clearTimeout(el._t);
      el._t = setTimeout(()=>{ el.hidden = true; }, 4000);
    };

  // libellés + ordre
  const PARTS = ["matin","midi","apresmidi","soir"];
  const PART_LABEL = { matin:"Matin", midi:"Midi", apresmidi:"Après-midi", soir:"Soir" };
  const DAYS_FR = ["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];

  function mondayIsoOf(dateIso){
    const d = new Date(dateIso || new Date().toISOString().slice(0,10));
    const day = (d.getDay()+6)%7; d.setDate(d.getDate()-day);
    return d.toISOString().slice(0,10);
  }
  function addDays(iso,n){ const d=new Date(iso); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }
  function labelDay(iso){
    const d=new Date(iso); const i=(d.getDay()+6)%7;
    return `${DAYS_FR[i]} ${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}`;
  }

  // -------- Rendu semainier agrégé (compte des créneaux réservés vs capacité) --------
  function renderPillbox(model){
    const root = document.getElementById('pillbox');
    root.querySelectorAll('.pillbox-day,.pillbox-slot').forEach(n=>n.remove());

    for (let i=0;i<7;i++){
      const dayIso = addDays(model.weekStart,i);
      const dlabel = document.createElement('div');
      dlabel.className="pillbox-day"; dlabel.setAttribute('role','rowheader'); dlabel.textContent = DAYS_FR[i];
      root.appendChild(dlabel);

      PARTS.forEach(part=>{
        const capacity = Number(model.capacity?.[part]||0);
        const count = Number(model.occ?.[dayIso]?.[part]||0);
        const ratio = capacity ? count / capacity : 0;

        const cell = document.createElement('button');
        cell.className = 'pillbox-slot'; cell.type = 'button'; cell.setAttribute('role', 'gridcell');
        cell.dataset.date = dayIso; cell.dataset.part = part;
        if (capacity === 0) {
          cell.disabled = true; cell.title = `${labelDay(dayIso)} — ${PART_LABEL[part]} indisponible`;
        } else if (count >= capacity) {
          cell.dataset.state = 'full'; cell.title = `${labelDay(dayIso)} — ${PART_LABEL[part]} : complet (${count}/${capacity})`;
        } else if (count > 0) {
          cell.dataset.state = 'busy'; cell.title = `${labelDay(dayIso)} — ${PART_LABEL[part]} : ${count}/${capacity}`;
        } else {
          cell.title = `${labelDay(dayIso)} — ${PART_LABEL[part]} : libre (0/${capacity})`;
        }
        if (ratio > 0) {
          cell.dataset.fill = ratio.toFixed(2);
          cell.style.setProperty('--fill', ratio.toFixed(2));
        }

        const badge=document.createElement('span'); badge.className='slot-label'; badge.textContent = capacity ? `${count}/${capacity}` : '—';
        cell.appendChild(badge);

        cell.addEventListener('click',()=> openTimePicker(dayIso, part));
        cell.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); cell.click(); } });

        root.appendChild(cell);
      });
    }
  }

  // -------- Chargement semaine (agrégats) --------
  function loadWeek(weekStartIso){
    const ws = weekStartIso || mondayIsoOf(document.getElementById('dateControl').value);
    if (google?.script?.run){
      google.script.run
        .withSuccessHandler(res => renderPillbox(res))
        .withFailureHandler(e => { console.error(e); toast('Erreur de chargement semaine.'); })
        .listWeekSlots(ws);
    } else {
      const capacity = { matin:16, midi:8, apresmidi:16, soir:12 };
      const occ = {};
      occ[ws] = { matin:5 }; occ[addDays(ws,2)] = { midi:7, apresmidi:10 }; occ[addDays(ws,4)] = { soir:4 };
      renderPillbox({ weekStart: ws, capacity, occ });
    }
  }

  // -------- Modal : choix d’un horaire --------
  const modal = {
    el: document.getElementById('timeModal'),
    list: document.getElementById('timeList'),
    title: document.getElementById('timeTitle'),
    btnOk: document.getElementById('btnConfirmTime'),
    btnCancel: document.getElementById('btnCancelTime'),
    sel: null,
    open(dateIso, part){
      this.el.hidden=false; this.sel=null; this.btnOk.disabled=true; this.btnOk.setAttribute('aria-disabled','true');
      this.title.textContent = `Choisir l’horaire — ${labelDay(dateIso)} • ${PART_LABEL[part]}`;
      this.list.innerHTML='…';
      if (google?.script?.run){
        google.script.run
          .withSuccessHandler(times => this.renderTimes(dateIso, part, times))
          .withFailureHandler(e => { console.error(e); toast('Erreur de lecture des horaires.'); })
          .listAvailableTimes(dateIso, part);
      } else {
        const times = Array.from({length:16},(_,i)=>({t:`${String(8+Math.floor(i/4)).padStart(2,'0')}:${String((i%4)*15).padStart(2,'0')}`, available:i%5!==0}));
        this.renderTimes(dateIso, part, times);
      }
    },
    renderTimes(dateIso, part, times){
      this.list.innerHTML='';
      times.forEach(({t,available})=>{
        const b=document.createElement('button');
        b.type='button'; b.className='time-btn'; b.textContent=t; b.disabled=!available; b.setAttribute('role','option'); b.setAttribute('aria-selected','false');
        b.addEventListener('click', ()=>{
          this.list.querySelectorAll('.time-btn').forEach(x=>{ x.classList.remove('selected'); x.setAttribute('aria-selected','false'); });
          b.classList.add('selected'); b.setAttribute('aria-selected','true'); this.sel = t; this.btnOk.disabled=false; this.btnOk.setAttribute('aria-disabled','false'); b.focus();
        });
        this.list.appendChild(b);
      });
      this.btnOk.onclick = ()=>{
        if (!this.sel) return;
        google?.script?.run
          ?.withSuccessHandler(res=>{ toast('Réservation créée'+(res?.id?` #${res.id}`:'')); this.close(); loadWeek(mondayIsoOf(dateIso)); })
          ?.withFailureHandler(e=>{ console.error(e); toast('Création impossible.'); })
          ?.createReservation({ date: dateIso, part, start: this.sel });
        if (!google?.script?.run){ this.close(); toast(`Mock: ${dateIso} ${part} ${this.sel}`); }
      };
    },
    close(){ this.el.hidden=true; this.sel=null; this.btnOk.disabled=true; this.btnOk.setAttribute('aria-disabled','true'); }
  };
  modal.btnCancel.addEventListener('click',()=>modal.close());
  modal.el.addEventListener('click', e=>{ if(e.target.hasAttribute('data-close')) modal.close(); });

  function openTimePicker(dateIso, part){ modal.open(dateIso, part); }

  (function patchDateControlForWeek(){
    const el=document.getElementById('dateControl'); if(!el) return;
    el.addEventListener('change', ()=> loadWeek(mondayIsoOf(el.value)));
  })();
  document.addEventListener('DOMContentLoaded', ()=>{
    const today = document.getElementById('dateControl');
    const iso = today?.value || new Date().toISOString().slice(0,10);
    if (today) today.value = iso;
    loadWeek(mondayIsoOf(iso));
  });
  </script>

