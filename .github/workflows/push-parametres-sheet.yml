name: Deploy Apps Script (root)

on:
  push:
    branches: [ main, test ]
    paths:
      - "appsscript.json"
      - ".claspignore"
      - "*.gs"
      - "*.html"
      - ".github/workflows/apps-script-deploy.yml"
      - "!**/apps-script/**"   # on ignore l'ancien dossier si présent
  workflow_dispatch:

env:
  APPS_DIR: .              # racine du repo
  CLASP_VERSION: 2.5.0

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Auth via CLASPRC_JSON (OAuth exporté)
      - name: Prepare OAuth credentials
        run: |
          test -n "${{ secrets.CLASPRC_JSON }}" || { echo "Missing CLASPRC_JSON"; exit 1; }
          echo "${{ secrets.CLASPRC_JSON }}" > ~/.clasprc.json
          chmod 600 ~/.clasprc.json

      # .clasp.json au ROOT avec le bon scriptId selon la branche
      - name: Write .clasp.json (root)
        working-directory: ${{ env.APPS_DIR }}
        run: |
          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            SID="${{ secrets.PROD_SCRIPT_ID }}"
          else
            SID="${{ secrets.TEST_SCRIPT_ID }}"
          fi
          test -n "$SID" || { echo "Missing PROD_SCRIPT_ID/TEST_SCRIPT_ID"; exit 1; }
          cat > .clasp.json <<EOF
          {
            "scriptId": "$SID",
            "rootDir": "."
          }
          EOF

      - name: Install clasp
        run: npm i -g @google/clasp@${{ env.CLASP_VERSION }}

      # (optionnel) build/format/test ici si besoin

      - name: Push to Apps Script
        working-directory: ${{ env.APPS_DIR }}
        run: clasp push -f

      - name: Create version
        id: ver
        working-directory: ${{ env.APPS_DIR }}
        run: |
          MSG="ci:${GITHUB_SHA::7}"
          clasp version "$MSG"
          echo "msg=$MSG" >> "$GITHUB_OUTPUT"

      - name: Deploy
        working-directory: ${{ env.APPS_DIR }}
        run: clasp deploy --description "${{ steps.ver.outputs.msg }}"
