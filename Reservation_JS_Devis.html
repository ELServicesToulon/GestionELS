<script>
// Gestion du téléchargement de devis PDF depuis la page de réservation
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('btn-telecharger-devis');
  if (btn) {
    btn.addEventListener('click', () => {
      if (typeof telechargerDevisPdf === 'function') {
        telechargerDevisPdf();
      } else {
        // Fallback inline si la fonction n'est pas disponible
        const ui = window.ui || {};
        const etat = window.etat || {};
        const panier = Array.isArray(etat.panier) ? etat.panier : [];
        if (panier.length === 0) { alert('Votre panier est vide.'); return; }
        const email = (ui.champEmailClient && ui.champEmailClient.value || '').trim() || (etat.clientReconnu && etat.clientReconnu.email) || '';
        const client = { email: email, nom: (ui.champNomClient && ui.champNomClient.value || '').trim(), adresse: (ui.champAdresseClient && ui.champAdresseClient.value || '').trim() };
        const items = panier.map(it => ({ date: it.date, startTime: it.startTime, details: it.details, prix: it.prix }));
        google.script.run.withSuccessHandler(res => { if (res && res.success && res.url) { try { window.open(res.url, '_blank'); } catch(e) {} } }).genererDevisPdfFromItems({ client, items });
      }
    });
  }
});
</script>
