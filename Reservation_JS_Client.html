<script>
/**
 * =================================================================
 * MODULE JAVASCRIPT - GESTION DU CLIENT
 * =================================================================
 * Description: Gère la session client (localStorage) pour pré-remplir
 * les informations et personnaliser l'accueil.
 */

const CLE_LOCALSTORAGE_CLIENT = 'sessionClientELServices';
const CLIENT_SESSION_OPAQUE_ID_ENABLED = <?!= CLIENT_SESSION_OPAQUE_ID_ENABLED ?>;
const CLIENT_SESSION_TTL_HOURS = <?!= CLIENT_SESSION_TTL_HOURS ?>;
const EMAIL_CLIENT_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
let portailClientLienEnCours = null;

/**
 * Vérifie si une session client existe dans le localStorage.
 */
function verifierSessionClient() {
  const sessionSauvegardee = localStorage.getItem(CLE_LOCALSTORAGE_CLIENT);
  if (!sessionSauvegardee) return;
  try {
    const session = JSON.parse(sessionSauvegardee);
    if (CLIENT_SESSION_TTL_HOURS && session.ts) {
      const ageHeures = (Date.now() - session.ts) / 36e5;
      if (ageHeures > CLIENT_SESSION_TTL_HOURS) {
        localStorage.removeItem(CLE_LOCALSTORAGE_CLIENT);
        return;
      }
    }
    const identifiant = CLIENT_SESSION_OPAQUE_ID_ENABLED ? session.token : session.email;
    preRemplirInfosClient(identifiant);
  } catch (e) {
    localStorage.removeItem(CLE_LOCALSTORAGE_CLIENT);
  }
}

/**
 * Pré-remplit les informations du client s'il est reconnu.
 * @param {string} identifiant Email ou jeton opaque du client.
 */
function preRemplirInfosClient(identifiant) {
  if (!identifiant) return;

  const banniere = document.getElementById('banniere-client-reconnu');
  const nomClientEl = document.getElementById('nom-client-reconnu');

  basculerIndicateurChargement(true);
  const runner = google.script.run
    .withSuccessHandler(client => {
      basculerIndicateurChargement(false);
      if (client && window.ui) {
        window.etat.clientReconnu = client;
        try {
          document.dispatchEvent(new CustomEvent('els-client-recognized', { detail: client }));
        } catch (_evtErr) {
          // ignore dispatch errors (CustomEvent unsupported)
        }
        memoriserClientReconnu(client);
        if (window.ui.champEmailClient) window.ui.champEmailClient.value = client.email || '';
        if (window.ui.champNomClient) window.ui.champNomClient.value = client.nom || '';
        if (window.ui.champAdresseClient) window.ui.champAdresseClient.value = client.adresse || '';
        if (window.ui.champSiretClient) window.ui.champSiretClient.value = client.siret || '';
        if (window.ui.champResidentClient) window.ui.champResidentClient.checked = !!client.resident;
        if (nomClientEl) nomClientEl.textContent = client.nom;
        if (banniere) banniere.classList.remove('hidden');
      }
    })
    .withFailureHandler(afficherErreur);

  if (CLIENT_SESSION_OPAQUE_ID_ENABLED && !identifiant.includes('@')) {
    runner.rechercherClientParIdentifiant(identifiant);
  } else {
    runner.rechercherClientParEmail(identifiant);
  }
}

async function genererIdentifiantClient(email) {
  const data = new TextEncoder().encode(String(email).trim().toLowerCase());
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

async function sauvegarderSessionClient(email) {
  if (!email) return;
  const token = await genererIdentifiantClient(email);
  const session = { token: token, ts: Date.now() };
  localStorage.setItem(CLE_LOCALSTORAGE_CLIENT, JSON.stringify(session));
}

/**
 * M�morise un client reconnu dans le stockage local pour faciliter les futurs acc�s.
 * @param {{email:string,nom?:string,adresse?:string,siret?:string,resident?:boolean}} client
 */
function memoriserClientReconnu(client) {
  if (!client || !client.email) return;
  if (CLIENT_SESSION_OPAQUE_ID_ENABLED) {
    sauvegarderSessionClient(client.email);
    return;
  }
  const snapshot = {
    email: client.email || '',
    nom: client.nom || '',
    adresse: client.adresse || '',
    siret: client.siret || '',
    resident: !!client.resident,
    ts: Date.now()
  };
  try {
    localStorage.setItem(CLE_LOCALSTORAGE_CLIENT, JSON.stringify(snapshot));
  } catch (err) {
    console.warn('[ELS] Impossible de m�moriser le client reconnu:', err);
  }
}

/**
 * Réinitialise la session client et vide les champs.
 */
function reinitialiserClient() {
  localStorage.removeItem(CLE_LOCALSTORAGE_CLIENT);
  window.etat.clientReconnu = null;
  try {
    document.dispatchEvent(new Event('els-client-cleared'));
  } catch (_evtErr) {
    // ignore dispatch errors
  }
  if (window.ui && window.ui.formulaireReservation) {
    window.ui.formulaireReservation.reset();
    if (window.ui.champResidentClient) {
      window.ui.champResidentClient.checked = false;
    }
  }
  const banniere = document.getElementById('banniere-client-reconnu');
  if (banniere) {
    banniere.classList.add('hidden');
  }
}

/**
 * Demande une connexion client via un prompt et pré-remplit les informations.
 */
function demanderConnexionClient() {
  const email = window.prompt('Entrez votre adresse email pour vous connecter à votre espace client :');
  if (!email) return;
  const emailTrim = email.trim();
  if (!EMAIL_CLIENT_REGEX.test(emailTrim)) {
    alert('Merci de renseigner une adresse email valide.');
    return;
  }
  preRemplirInfosClient(emailTrim);
}

/**
 * Met à jour le lien "Mon Espace Client" selon l'état de connexion.
 * @param {{email?:string}|null} client
 */
function mettreAJourLienEspaceClient(client) {
  const lien = document.getElementById('btn-espace-client');
  const btnConnexion = document.getElementById('btn-connecter-client');
  const baseUrl = (window.configServeur && window.configServeur.appUrl) || '';
  const defaultHref = baseUrl ? `${baseUrl}?page=gestion` : '#';

  if (!lien) return;

  if (!client || !client.email) {
    portailClientLienEnCours = null;
    lien.href = defaultHref;
    btnConnexion?.classList.remove('hidden');
    return;
  }

  btnConnexion?.classList.add('hidden');
  portailClientLienEnCours = client.email;

  const fallback = () => {
    if (portailClientLienEnCours !== client.email) return;
    if (!defaultHref || defaultHref === '#') {
      lien.href = '#';
      return;
    }
    const separator = defaultHref.includes('?') ? '&' : '?';
    lien.href = `${defaultHref}${separator}email=${encodeURIComponent(client.email)}`;
  };

  fallback();

  if (google && google.script && google.script.run && typeof google.script.run.client_getPortalLink === 'function') {
    google.script.run
      .withSuccessHandler(res => {
        if (portailClientLienEnCours !== client.email) return;
        if (res && res.success && res.url) {
          lien.href = res.url;
        } else {
          fallback();
        }
      })
      .withFailureHandler(() => fallback())
      .client_getPortalLink(client.email);
  } else {
    fallback();
  }
}

document.addEventListener('els-client-recognized', (event) => {
  mettreAJourLienEspaceClient(event?.detail || window.etat?.clientReconnu || null);
});

document.addEventListener('els-client-cleared', () => {
  mettreAJourLienEspaceClient(null);
});

mettreAJourLienEspaceClient(window.etat?.clientReconnu || null);
</script>


