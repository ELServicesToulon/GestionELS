<script>
/**
 * =================================================================
 * MODULE JAVASCRIPT - GESTION DU CLIENT
 * =================================================================
 * Description: Gère la session client (localStorage) pour pré-remplir
 * les informations et personnaliser l'accueil.
 */

const CLE_LOCALSTORAGE_CLIENT = 'sessionClientELServices';
const CLIENT_SESSION_OPAQUE_ID_ENABLED =
  <?!= (typeof CLIENT_SESSION_OPAQUE_ID_ENABLED !== 'undefined'
        ? CLIENT_SESSION_OPAQUE_ID_ENABLED : false) ?>;
const CLIENT_SESSION_TTL_HOURS = <?!= CLIENT_SESSION_TTL_HOURS ?>;

/**
 * Vérifie si une session client existe dans le localStorage.
 */
function verifierSessionClient() {
  const sessionSauvegardee = localStorage.getItem(CLE_LOCALSTORAGE_CLIENT);
  if (!sessionSauvegardee) return;
  try {
    const session = JSON.parse(sessionSauvegardee);
    if (CLIENT_SESSION_TTL_HOURS && session.ts) {
      const ageHeures = (Date.now() - session.ts) / 36e5;
      if (ageHeures > CLIENT_SESSION_TTL_HOURS) {
        localStorage.removeItem(CLE_LOCALSTORAGE_CLIENT);
        return;
      }
    }
    const identifiant = CLIENT_SESSION_OPAQUE_ID_ENABLED ? session.token : session.email;
    preRemplirInfosClient(identifiant);
  } catch (e) {
    localStorage.removeItem(CLE_LOCALSTORAGE_CLIENT);
  }
}

/**
 * Pré-remplit les informations du client s'il est reconnu.
 * @param {string} identifiant Email ou jeton opaque du client.
 */
function preRemplirInfosClient(identifiant) {
  if (!identifiant) return;

  const banniere = document.getElementById('banniere-client-reconnu');
  const nomClientEl = document.getElementById('nom-client-reconnu');

  basculerIndicateurChargement(true);
  const runner = google.script.run
    .withSuccessHandler(client => {
      basculerIndicateurChargement(false);
      if (client && window.ui) {
        window.etat.clientReconnu = client;
        if (window.ui.champEmailClient) window.ui.champEmailClient.value = client.email || '';
        if (window.ui.champNomClient) window.ui.champNomClient.value = client.nom || '';
        if (window.ui.champAdresseClient) window.ui.champAdresseClient.value = client.adresse || '';
        if (window.ui.champSiretClient) window.ui.champSiretClient.value = client.siret || '';
        if (nomClientEl) nomClientEl.textContent = client.nom;
        if (banniere) banniere.classList.remove('hidden');
      }
    })
    .withFailureHandler(afficherErreur);

  if (CLIENT_SESSION_OPAQUE_ID_ENABLED && !identifiant.includes('@')) {
    runner.rechercherClientParIdentifiant(identifiant);
  } else {
    runner.rechercherClientParEmail(identifiant);
  }
}

async function genererIdentifiantClient(email) {
  const data = new TextEncoder().encode(String(email).trim().toLowerCase());
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

async function sauvegarderSessionClient(email) {
  if (!email) return;
  const token = await genererIdentifiantClient(email);
  const session = { token: token, ts: Date.now() };
  localStorage.setItem(CLE_LOCALSTORAGE_CLIENT, JSON.stringify(session));
}
/**
 * Réinitialise la session client et vide les champs.
 */
function reinitialiserClient() {
    localStorage.removeItem(CLE_LOCALSTORAGE_CLIENT);
    window.etat.clientReconnu = null;
    if (window.ui && window.ui.formulaireReservation) {
        window.ui.formulaireReservation.reset();
    }
    const banniere = document.getElementById('banniere-client-reconnu');
    if (banniere) {
        banniere.classList.add('hidden');
    }
}
</script>


