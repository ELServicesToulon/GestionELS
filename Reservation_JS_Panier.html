<script>
/**
 * =================================================================
 * MODULE JAVASCRIPT - GESTION DU PANIER
 * =================================================================
 * Description: Gère l'ajout, la suppression et l'affichage des
 * tournées dans le panier du client.
 */

/**
 * Ajoute la tournée configurée au panier global.
 */
function ajouterTourneeAuPanier() {
  const { ui } = window;
  const { tourneeEnCours } = window.etat;
  const creneauSelectionneBtn = ui.grilleSelectionCreneau.querySelector('.slot-btn.selected');
  const estRecurrent = document.getElementById('interrupteur-recurrence').checked;

  if (!creneauSelectionneBtn) {
    afficherNotification("Veuillez sélectionner un créneau.", "erreur");
    return;
  }

  const nouvelleTournee = {
    id: 'tournee-' + Date.now(),
    date: tourneeEnCours.date,
    startTime: creneauSelectionneBtn.dataset.creneau,
    totalStops: tourneeEnCours.totalStops,
    returnToPharmacy: tourneeEnCours.returnToPharmacy,
    prix: parseFloat(creneauSelectionneBtn.dataset.prix),
    duree: tourneeEnCours.duree,
    details: formatCourseLabel(tourneeEnCours.duree, tourneeEnCours.totalStops, tourneeEnCours.returnToPharmacy),
    isRecurrent: estRecurrent // Nouvelle propriété
  };

  window.etat.panier.push(nouvelleTournee);
  
  afficherPanier();
  sauvegarderPanierDansLocalStorage();
  
  ui.modaleSelectionCreneau.classList.add('hidden');
  afficherNotification("Tournée ajoutée au panier !", "succes");
}

/**
 * Met à jour l'affichage du panier dans l'interface.
 */
function afficherPanier() {
  const { ui } = window;
  const { panier } = window.etat;
  const hasResidentItems = panier.some(item => item.resident === true || item.residentMode);

  if (panier.length === 0) {
    ui.listePanier.textContent = '';
    const p = document.createElement('p');
    p.className = 'panier-vide';
    p.textContent = 'Votre panier est vide.';
    ui.listePanier.appendChild(p);
    ui.panierPiedDePage.classList.add('hidden');
    return;
  }

  ui.listePanier.textContent = '';
  panier.forEach(item => {
    const date = new Date(item.date + 'T00:00:00');
    const dateFormatee = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });

    const li = document.createElement('li');
    li.className = 'item-panier';
    li.dataset.idItem = item.id;

    const infosDiv = document.createElement('div');
    infosDiv.className = 'item-panier-infos';

    const strong = document.createElement('strong');
    strong.textContent = `Le ${dateFormatee} à ${item.startTime}`;
    infosDiv.appendChild(strong);

    if (item.isRecurrent) {
      const smallRec = document.createElement('small');
      smallRec.style.color = 'var(--couleur-recurrence, #ccc)';
      smallRec.style.display = 'block';
      smallRec.textContent = '(Récurrence mensuelle)';
      infosDiv.appendChild(smallRec);
    }

    const smallDetails = document.createElement('small');
    smallDetails.textContent = item.details;
    infosDiv.appendChild(smallDetails);

    const isResidentItem = item.resident === true || !!item.residentMode;
    const residentLibelle = item.residentLibelle || (isResidentItem ? obtenirLibelleResident(item.residentMode || 'standard') : '');
    const prixAffiche = Number.isFinite(item.residentPrix) ? item.residentPrix : item.prix;

    if (isResidentItem && residentLibelle) {
      const badgeResident = document.createElement('small');
      badgeResident.className = 'badge-resident';
      badgeResident.textContent = residentLibelle;
      infosDiv.appendChild(badgeResident);
    }

    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'item-panier-actions';
    const spanPrix = document.createElement('span');
    spanPrix.className = 'item-panier-prix';
    spanPrix.textContent = Number.isFinite(prixAffiche) ? `${prixAffiche.toFixed(2)} €` : 'Forfait';
    const btnSupprimer = document.createElement('button');
    btnSupprimer.className = 'item-panier-supprimer';
    btnSupprimer.setAttribute('aria-label', 'Supprimer cet article');
    btnSupprimer.textContent = '×';
    actionsDiv.appendChild(spanPrix);
    actionsDiv.appendChild(btnSupprimer);

    li.appendChild(infosDiv);
    li.appendChild(actionsDiv);
    ui.listePanier.appendChild(li);
  });

  const total = panier.reduce((acc, item) => {
    const prixCourant = Number.isFinite(item.residentPrix) ? item.residentPrix : item.prix;
    return acc + (Number.isFinite(prixCourant) ? prixCourant : 0);
  }, 0);
  const prefix = hasResidentItems ? '' : '~ ';
  ui.panierTotalValeur.textContent = `${prefix}${total.toFixed(2)} €`; // Ajout de '~' car le total peut augmenter avec la récurrence
  ui.panierPiedDePage.classList.remove('hidden');
}

/**
 * Gère les actions dans le panier (ex: suppression d'un item).
 */
function gererActionsPanier(e) {
  if (e.target.classList.contains('item-panier-supprimer')) {
    const itemId = e.target.closest('.item-panier').dataset.idItem;
    const item = window.etat.panier.find(i => i.id === itemId);
    window.etat.panier = window.etat.panier.filter(item => item.id !== itemId);
    afficherPanier();
    sauvegarderPanierDansLocalStorage();
    if (item && typeof ajusterDisponibiliteJour === 'function') {
      try { ajusterDisponibiliteJour(item.date, +1); } catch (err) {}
    }
    afficherNotification("Tournée retirée du panier.", "info");
  }
}

/**
 * Sauvegarde le panier dans le localStorage du navigateur.
 */
function sauvegarderPanierDansLocalStorage() {
  localStorage.setItem('panierReservationELS', JSON.stringify(window.etat.panier));
}

/**
 * Charge le panier depuis le localStorage au démarrage de l'application.
 */
function chargerPanierDepuisLocalStorage() {
  const panierSauvegarde = localStorage.getItem('panierReservationELS');
  if (panierSauvegarde) {
    window.etat.panier = JSON.parse(panierSauvegarde);
    afficherPanier();
  }
}

/**
 * Vide complètement le panier et restaure les disponibilités.
 */
function viderPanier() {
  const { panier } = window.etat;
  panier.forEach(item => {
    if (typeof ajusterDisponibiliteJour === 'function') {
      try { ajusterDisponibiliteJour(item.date, +1); } catch (err) {}
    }
  });
  window.etat.panier = [];
  sauvegarderPanierDansLocalStorage();
  afficherPanier();
  afficherNotification("Panier vidé.", "info");
}
</script>

